<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Doctor Directory - GabayAI</title>
<link rel="stylesheet" href="navbar.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
  body{
    margin:0;
    background:#f8fafc;
    min-height:100vh;
  }
  .doctor-content {
    max-width: 1200px;
    margin: 90px auto 30px;
    padding: 0 20px;
    box-sizing:border-box;
  }
  .page-header {
    background: #fff;
    padding: 25px 30px;
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    margin-bottom: 30px;
    border: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
  }
  .back-btn {
    background: #4c6ef5;
    color: #fff;
    border: none;
    padding: 14px 26px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 500;
    transition: all 0.2s ease;
    box-shadow: 0 4px 6px rgba(76, 110, 245, 0.15);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .back-btn:hover {
    background: #3b5bdb;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(76, 110, 245, 0.2);
  }
  .search-container {
    flex: 1;
    max-width: 500px;
    position: relative;
  }
  .search-bar {
    width: 100%;
    padding: 14px 50px 14px 16px;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    font-size: 15px;
    transition: all 0.2s ease;
    background: #f8f9fa;
  }
  .search-bar:focus {
    border-color: #4c6ef5;
    outline: none;
    box-shadow: 0 0 0 3px rgba(76, 110, 245, 0.15);
    background: #fff;
  }
  .search-icon {
    position: absolute;
    right: 18px;
    top: 50%;
    transform: translateY(-50%);
    color: #999;
    font-size: 16px;
  }
  .doctor-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 25px;
  }
  .doctor-card {
    background: #fff;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border: 1px solid #e2e8f0;
    transition: all 0.2s ease;
    position: relative;
  }
  .doctor-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    border-color: #4c6ef5;
  }
  .card-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 18px;
  }
  .doctor-avatar {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #f0f4ff;
    flex-shrink: 0;
    background:#f3f4f6;
  }
  .doctor-info { flex: 1; }
  .doctor-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: #4c6ef5;
    margin-bottom: 6px;
  }
  .doctor-specialty {
    font-size: 0.95rem;
    color: #4a5568;
    margin-bottom: 8px;
  }
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    user-select:none;
  }
  .status-badge.available { background: #d4edda; color: #155724; }
  .status-badge.not-available { background: #f1f5f9; color: #475569; }
  .status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    display: inline-block;
  }
  .status-badge.available .status-dot { background: #28a745; }
  .status-badge.not-available .status-dot { background: #94a3b8; }
  .card-schedule {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    margin-top: 15px;
  }
  .schedule-row {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.9rem;
    color: #4a5568;
    margin-bottom: 8px;
    line-height: 1.5;
  }
  .schedule-row:last-child { margin-bottom: 0; }
  .schedule-icon {
    color: #4c6ef5;
    width: 16px;
    flex-shrink: 0;
  }
  .chat-btn{
    width:100%;
    margin-top:16px;
    padding:12px 14px;
    border:none;
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    transition:.2s;
  }
  .chat-btn.enabled{
    background: linear-gradient(90deg, #4c6ef5, #7c3aed);
    color:#fff;
    box-shadow: 0 8px 18px rgba(76, 110, 245, 0.18);
  }
  .chat-btn.enabled:hover{ transform: translateY(-1px); }
  .chat-btn.disabled{
    background:#e5e7eb;
    color:#9ca3af;
    cursor:not-allowed;
  }
  .loading,
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
    grid-column: 1 / -1;
  }
  .loading .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #4c6ef5;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  .empty-state i {
    font-size: 3.5rem;
    margin-bottom: 20px;
    opacity: 0.3;
    color: #4c6ef5;
  }

  /* MODAL / FORM */

  .modal-overlay{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background: rgba(0,0,0,.55);
    z-index: 99999;
    padding: 18px;
    backdrop-filter: blur(3px);
  }
  .modal{
    width:100%;
    max-width: 820px;
    background:#fff;
    border-radius: 16px;
    box-shadow: 0 20px 50px rgba(0,0,0,.25);
    overflow:hidden;
    animation: pop .18s ease-out;
  }
  @keyframes pop{
    from{ opacity:0; transform: translateY(10px); }
    to{ opacity:1; transform: translateY(0); }
  }
  .modal-head{
    padding: 18px 20px;
    border-bottom:1px solid #e2e8f0;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    background: linear-gradient(135deg, rgba(76,110,245,.12), rgba(124,58,237,.10));
  }
  .modal-head h3{ margin:0; color:#4c6ef5; }
  .modal-head p{ margin:6px 0 0; color:#475569; font-size:.92rem; }
  .modal-close{
    border:none;
    background:none;
    font-size:22px;
    cursor:pointer;
    color:#64748b;
  }
  .modal-close:hover{ color:#0f172a; }
  .modal-body{
    padding: 18px 20px;
    max-height: 75vh;
    overflow:auto;
  }
  .grid-2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  @media (max-width: 760px){
    .grid-2{ grid-template-columns: 1fr; }
  }
  .field label{
    display:block;
    font-weight:700;
    font-size:.88rem;
    margin-bottom:6px;
    color:#0f172a;
  }
  .input, .select, .textarea{
    width:100%;
    padding: 11px 12px;
    border:1px solid #e2e8f0;
    border-radius:10px;
    outline:none;
    background:#fff;
    box-sizing:border-box;
    font-size: 1rem;
  }
  .textarea{ min-height: 90px; resize: vertical; }
  .input:focus, .select:focus, .textarea:focus{
    border-color:#4c6ef5;
    box-shadow: 0 0 0 3px rgba(76,110,245,.15);
  }
  .section{
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px dashed #e2e8f0;
  }
  .section h4{ margin:0 0 10px; color:#111827; }
  .checks{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
    gap: 10px;
  }
  .chk{
    display:flex;
    align-items:flex-start;
    gap:10px;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #e2e8f0;
    background:#f8fafc;
    cursor:pointer;
    user-select:none;
  }
  .chk:hover{
    border-color:#4c6ef5;
    background:#eef2ff;
  }
  .chk input{
    transform: scale(1.1);
    margin-top:2px;
    accent-color:#4c6ef5;
  }
  .modal-foot{
    padding: 14px 20px 18px;
    border-top:1px solid #e2e8f0;
    display:flex;
    gap:10px;
  }
  .btn{
    width:100%;
    padding: 12px 14px;
    border-radius: 10px;
    border:none;
    cursor:pointer;
    font-weight:800;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
  }
  .btn.primary{
    background: linear-gradient(90deg, #4c6ef5, #7c3aed);
    color:#fff;
  }
  .btn.outline{
    background:#fff;
    border:1px solid #e2e8f0;
    color:#0f172a;
  }
</style>
</head>
<body>
<nav class="navbar">
  <div class="navbar-container">
    <a href="homer.html" class="navbar-logo">GabayAI</a>
    <ul class="navbar-nav">
      <li><a href="homer.html" class="nav-link ">Dashboard</a></li>
      <li><a href="analyzerv2.html" class="nav-link ">Analyzer</a></li>
      <li><a href="consult.html" class="nav-link active">Consultation</a></li>
      <li><a href="editaccount.html" class="nav-link">Profile</a></li>
      <li>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </button>
      </li>
    </ul>

    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
      <div class="hamburger" id="hamburger">
        <span></span><span></span><span></span>
      </div>
    </button>
  </div>

  <div class="mobile-menu" id="mobileMenu">
    <div class="mobile-menu-items">
      <a href="homer.html" class="mobile-nav-link ">Dashboard</a>
      <a href="analyzerv2.html" class="mobile-nav-link ">Analyzer</a>
      <a href="consult.html" class="mobile-nav-link active">Consultation</a>
      <a href="editaccount.html" class="mobile-nav-link ">Profile</a>

      <div class="mobile-logout">
        <button onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </button>
      </div>
    </div>
  </div>
</nav>

<div class="doctor-content">
  <div class="page-header">
    <button class="back-btn" onclick="history.back()">
      <i class="fas fa-arrow-left"></i>
      Back
    </button>

    <div class="search-container">
      <input type="text" class="search-bar" id="searchInput"
             placeholder="Search by name or specialty..." />
      <i class="fas fa-search search-icon"></i>
    </div>
  </div>

  <div id="doctorList" class="doctor-grid">
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading doctors...</p>
    </div>
  </div>
</div>

<!-- PATIENT INTAKE MODAL -->
<div id="intakeOverlay" class="modal-overlay">
  <div class="modal">
    <div class="modal-head">
      <div>
        <h3><i class="fas fa-clipboard-list"></i> Patient Screening</h3>
        <p>Doctor: <strong id="modalDocName">—</strong> · <span id="modalDocSpec">—</span></p>
      </div>
      <button class="modal-close" onclick="closeIntake()" aria-label="Close">&times;</button>
    </div>

    <form id="intakeForm">
      <div class="modal-body">
        <input type="hidden" id="selectedDocId" />

        <div class="grid-2">
          <div class="field">
            <label>Full Name</label>
            <input class="input" id="pName" type="text" required placeholder="e.g. Juan Dela Cruz">
          </div>
          <div class="field">
            <label>Contact Number</label>
            <input class="input" id="pPhone" type="tel" placeholder="09xx...">
          </div>

          <div class="field">
            <label>Age</label>
            <input class="input" id="pAge" type="number" min="0" max="120" required placeholder="e.g. 21">
          </div>
          <div class="field">
            <label>Sex</label>
            <select class="select" id="pSex" required>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Prefer not to say">Prefer not to say</option>
            </select>
          </div>

          <div class="field">
            <label>Duration</label>
            <select class="select" id="pDuration">
              <option>Less than 24 hours</option>
              <option>1-3 days</option>
              <option>4-7 days</option>
              <option>More than a week</option>
              <option>More than a month</option>
            </select>
          </div>
          <div class="field">
            <label>Severity</label>
            <select class="select" id="pSeverity">
              <option>Mild</option>
              <option>Moderate</option>
              <option>Severe</option>
            </select>
          </div>
        </div>

        <div class="field" style="margin-top:12px;">
          <label>Chief Complaint</label>
          <textarea class="textarea" id="pComplaint" required placeholder="e.g. Fever + headache for 3 days..."></textarea>
        </div>

        <div class="grid-2">
          <div class="field">
            <label>Do you have fever now?</label>
            <select class="select" id="pFeverNow">
              <option>No</option>
              <option>Yes</option>
              <option>Not sure</option>
            </select>
          </div>
          <div class="field">
            <label>Temperature (optional)</label>
            <input class="input" id="pTemp" type="text" placeholder="e.g. 38.5°C">
          </div>
        </div>

        <div class="section">
          <h4>Medical History</h4>
          <div class="checks" id="historyChecks">
            <label class="chk"><input type="checkbox" value="Hypertension"> Hypertension</label>
            <label class="chk"><input type="checkbox" value="Diabetes"> Diabetes</label>
            <label class="chk"><input type="checkbox" value="Asthma"> Asthma</label>
            <label class="chk"><input type="checkbox" value="Heart Disease"> Heart Disease</label>
            <label class="chk"><input type="checkbox" value="Kidney Disease"> Kidney Disease</label>
            <label class="chk"><input type="checkbox" value="Liver Disease"> Liver Disease</label>
            <label class="chk"><input type="checkbox" value="Pregnant"> Pregnant</label>
            <label class="chk"><input type="checkbox" value="None" data-none="history"> None</label>
          </div>
        </div>

        <div class="section">
          <h4>Allergies</h4>
          <div class="checks" id="allergyChecks">
            <label class="chk"><input type="checkbox" value="Antibiotics"> Antibiotics</label>
            <label class="chk"><input type="checkbox" value="NSAIDs/Aspirin"> NSAIDs / Aspirin</label>
            <label class="chk"><input type="checkbox" value="Paracetamol"> Paracetamol</label>
            <label class="chk"><input type="checkbox" value="Seafood"> Seafood</label>
            <label class="chk"><input type="checkbox" value="Eggs/Chicken"> Eggs / Chicken</label>
            <label class="chk"><input type="checkbox" value="Dust/Pollen"> Dust / Pollen</label>
            <label class="chk"><input type="checkbox" value="None" data-none="allergy"> None</label>
          </div>

          <div class="field" style="margin-top:10px;">
            <label>Other allergy details (optional)</label>
            <input class="input" id="pAllergyOther" type="text" placeholder="Type other allergies...">
          </div>
        </div>

        <div class="section">
          <h4>Questions to ask (from Analyzer)</h4>
          <div class="checks" id="topicChecks"></div>
        </div>

        <div class="section">
          <label class="chk" style="background:#fff;">
            <input type="checkbox" id="pConsent" required>
            I confirm the information above is true.
          </label>
        </div>
      </div>

      <div class="modal-foot">
        <button type="button" class="btn outline" onclick="closeIntake()">Cancel</button>
        <button type="submit" class="btn primary" id="startBtn">
          Start Consultation <i class="fas fa-comment-medical"></i>
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  function toggleMobileMenu() {
    const menu = document.getElementById('mobileMenu');
    const hamburger = document.getElementById('hamburger');
    menu.classList.toggle('show');
    hamburger.classList.toggle('open');
  }
  function logout() {
    if (confirm("Logout?")) window.location.href = "userlogout.php";
  }

  const DOCTORS_URL = 'getDoctors.php';
  const PRESENCE_URL = 'getDoctorPresence.php';
  const PRESENCE_POLL_MS = 4000;
  const SESSION_KEY = "gabay_consult_session";

  const ANALYZER_KEYS = [
    "gabay_analyzer_results",
    "analysisResults",
    "gabay_analysis",
    "gabayAI_analyzer",
    "gabay_ai_analysis"
  ];

  let doctorsCache = [];
  let onlineSet = new Set();

  function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    const div = document.createElement('div');
    div.textContent = String(str);
    return div.innerHTML;
  }

  function avatarUrl(name){
    const safe = encodeURIComponent(name || "Doctor");
    return `https://ui-avatars.com/api/?name=${safe}&background=EEF2FF&color=3730A3&rounded=true&size=160`; /* placeholder avatar API [web:34] */
  }

  function normalizeId(v){
    return String(v ?? "").trim();
  }

  function readAnalyzerTopics(){
    for(const k of ANALYZER_KEYS){
      try{
        const raw = localStorage.getItem(k);
        if(!raw) continue;
        const data = JSON.parse(raw);

        if(Array.isArray(data)){
          const list = data.map(x => String(x)).filter(Boolean);
          if(list.length) return list;
        }

        const candidates = [
          data.topics, data.findings, data.conditions, data.possibleConditions, data.results
        ].filter(Boolean);

        for(const c of candidates){
          if(Array.isArray(c) && c.length){
            return c.map(x =>
              typeof x === "string"
                ? x
                : (x.name || x.title || JSON.stringify(x))
            ).filter(Boolean);
          }
        }
      }catch(e){}
    }
    return [
      "Possible viral infection",
      "Dehydration / low fluid intake",
      "Headache / sinus pressure",
      "What medicine is safe for me?",
      "When should I go to ER?"
    ];
  }

  function wireNone(containerId, noneKey){
    const container = document.getElementById(containerId);
    container.addEventListener("change", (e)=>{
      const t = e.target;
      if(!(t instanceof HTMLInputElement) || t.type !== "checkbox") return;

      const noneBox = container.querySelector(`input[data-none="${noneKey}"]`);
      const boxes = Array.from(container.querySelectorAll('input[type="checkbox"]'));

      if(t === noneBox && noneBox.checked){
        boxes.forEach(b => { if(b !== noneBox) b.checked = false; });
      } else if(t !== noneBox && t.checked && noneBox){
        noneBox.checked = false;
      }
    });
  }

  function getChecked(containerId){
    return Array.from(document.querySelectorAll(
      `#${containerId} input[type="checkbox"]:checked`
    )).map(cb => cb.value);
  }

  function renderDoctors(doctors){
    const container = document.getElementById('doctorList');
    container.innerHTML = '';

    if (!doctors || doctors.length === 0) {
      container.innerHTML =
        '<div class="empty-state"><i class="fas fa-user-md"></i><p>No doctors found.</p></div>';
      return;
    }

    doctors.forEach((doc) => {
      const id = normalizeId(doc.id);
      const name = doc.fullname || doc.name || "Doctor";
      const spec = doc.specialization || doc.specialty || "General Practice";
      const days = doc.availabledays || doc.available_days || "Not specified";
      const hours = doc.availablehours || doc.available_hours || "Not specified";
      const photo = (doc.profilephoto || doc.image || "").trim();
      const img = photo ? photo : avatarUrl(name);

      const isOnline = onlineSet.has(id);
      const statusText = isOnline ? "ONLINE" : "OFFLINE";
      const statusClass = isOnline ? "available" : "not-available";

      const btnClass = isOnline ? "enabled" : "disabled";
      const btnDisabled = isOnline ? "" : "disabled";
      const btnText = isOnline ? "Chat Now" : "Offline";

      const card = document.createElement('div');
      card.className = 'doctor-card';
      card.innerHTML = `
        <div class="card-header">
          <img src="${escapeHtml(img)}"
               alt="${escapeHtml(name)}"
               class="doctor-avatar"
               onerror="this.src='${escapeHtml(avatarUrl(name))}'" />

          <div class="doctor-info">
            <div class="doctor-name">${escapeHtml(name)}</div>
            <div class="doctor-specialty">${escapeHtml(spec)}</div>
            <div class="status-badge ${statusClass}">
              <span class="status-dot"></span>
              ${statusText}
            </div>
          </div>
        </div>

        <div class="card-schedule">
          <div class="schedule-row">
            <i class="fas fa-calendar-alt schedule-icon"></i>
            <span><strong>Days:</strong> ${escapeHtml(days)}</span>
          </div>
          <div class="schedule-row">
            <i class="fas fa-clock schedule-icon"></i>
            <span><strong>Hours:</strong> ${escapeHtml(hours)}</span>
          </div>
        </div>

        <button class="chat-btn ${btnClass}" ${btnDisabled} data-chat="1">
          <i class="fas fa-comments"></i> ${btnText}
        </button>
      `;

      card.querySelector('[data-chat="1"]').addEventListener('click', ()=>{
        if(!isOnline) return;
        openIntake({ id, name, spec });
      });

      container.appendChild(card);
    });
  }

  function applySearch(){
    const filter = (document.getElementById('searchInput').value || "")
      .toLowerCase().trim();
    if(!filter) return renderDoctors(doctorsCache);

    const filtered = doctorsCache.filter(d => {
      const name = String(d.fullname || d.name || "").toLowerCase();
      const spec = String(d.specialization || d.specialty || "").toLowerCase();
      return name.includes(filter) || spec.includes(filter);
    });

    renderDoctors(filtered);
  }

  async function fetchDoctors() {
    const res = await fetch(DOCTORS_URL, { cache: "no-store" });
    if (!res.ok) throw new Error('Network error');
    const doctors = await res.json();
    if (doctors.error) throw new Error(doctors.error);

    doctorsCache = Array.isArray(doctors) ? doctors : [];
    applySearch();
  }

  async function fetchPresence(){
    const res = await fetch(PRESENCE_URL, { cache: "no-store" });
    if(!res.ok) throw new Error("Presence fetch failed");

    const data = await res.json();
    const set = new Set();

    if(Array.isArray(data)){
      if(data.length && typeof data[0] === "object"){
        data.forEach(row => {
          const id = normalizeId(row.id ?? row.doctor_id);
          const online = row.online ?? row.is_online ?? row.status;
          if(!id) return;
          if(String(online).toLowerCase() === "online" ||
             online === true || online === 1 || online === "1"){
            set.add(id);
          }
        });
      } else {
        data.forEach(id => set.add(normalizeId(id)));
      }
    } else if(data && typeof data === "object"){
      const ids = data.onlineIds || data.online_ids || data.online;
      if(Array.isArray(ids)){
        ids.forEach(id => set.add(normalizeId(id)));
      } else {
        Object.keys(data).forEach(k=>{
          const v = data[k];
          if(String(v).toLowerCase() === "online" ||
             v === true || v === 1 || v === "1"){
            set.add(normalizeId(k));
          }
        });
      }
    }

    onlineSet = set;
    applySearch();
  }

  const overlay = document.getElementById("intakeOverlay");
  const form = document.getElementById("intakeForm");
  const startBtn = document.getElementById("startBtn");

  function openIntake(doc){
    document.getElementById("selectedDocId").value = doc.id;
    document.getElementById("modalDocName").textContent = doc.name;
    document.getElementById("modalDocSpec").textContent = doc.spec;

    const wrap = document.getElementById("topicChecks");
    wrap.innerHTML = "";
    const topics = readAnalyzerTopics();
    topics.forEach((t, idx)=>{
      const id = `topic_${idx}_${Math.random().toString(16).slice(2)}`;
      wrap.insertAdjacentHTML("beforeend", `
        <label class="chk" for="${id}">
          <input id="${id}" type="checkbox" value="${escapeHtml(String(t))}" checked>
          ${escapeHtml(String(t))}
        </label>
      `);
    });

    wireNone("historyChecks", "history");
    wireNone("allergyChecks", "allergy");

    overlay.style.display = "flex";
  }

  function closeIntake(){
    overlay.style.display = "none";
    form.reset();
    document.getElementById("topicChecks").innerHTML = "";
  }

  overlay.addEventListener("click", (e)=>{
    if(e.target === overlay) closeIntake();
  });

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();

    const docId = document.getElementById("selectedDocId").value;
    if(!onlineSet.has(normalizeId(docId))){
      alert("Doctor is no longer online. Please pick another available doctor.");
      closeIntake();
      return;
    }

    const payload = {
      doctorId: docId,
      doctorName: document.getElementById("modalDocName").textContent,
      doctorSpecialization: document.getElementById("modalDocSpec").textContent,
      patient: {
        name: document.getElementById("pName").value.trim(),
        phone: document.getElementById("pPhone").value.trim(),
        age: document.getElementById("pAge").value.trim(),
        sex: document.getElementById("pSex").value,
        duration: document.getElementById("pDuration").value,
        severity: document.getElementById("pSeverity").value,
        complaint: document.getElementById("pComplaint").value.trim(),
        feverNow: document.getElementById("pFeverNow").value,
        temperature: document.getElementById("pTemp").value.trim(),
        history: getChecked("historyChecks"),
        allergies: getChecked("allergyChecks"),
        allergyOther: document.getElementById("pAllergyOther").value.trim(),
        topics: getChecked("topicChecks"),
        consent: document.getElementById("pConsent").checked ? 1 : 0
      },
      createdAt: new Date().toISOString()
    };

    startBtn.disabled = true;
    const originalHtml = startBtn.innerHTML;
    startBtn.innerHTML = 'Starting...';

    try {
      const res = await fetch('consult_start_new.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      console.log('RAW consult_start_new.php RESPONSE:', text);

      let result;
      try {
        result = JSON.parse(text);
      } catch (e) {
        alert('Response not JSON. HTTP ' + res.status + '\n' + text);
        return;
      }

      if (!res.ok || !result.success) {
        alert('PHP error: ' + (result.message || 'unknown') + '\n' + (result.error || ''));
        return;
      }

      localStorage.setItem(SESSION_KEY, JSON.stringify({
        ...payload,
        consultation_id: result.consultation_id
      }));

      alert('OK, consultation started. ID = ' + result.consultation_id);
      window.location.href =
        `chatdoc.html?consult=${encodeURIComponent(result.consultation_id)}`;
    } catch (err) {
      console.error('Fetch error:', err);
      alert('Fetch error: ' + err);
    } finally {
      startBtn.disabled = false;
      startBtn.innerHTML = originalHtml;
    }
  });

  document.getElementById('searchInput').addEventListener('input', applySearch);

  (async function init(){
    try{
      await fetchDoctors();
      try{ await fetchPresence(); }catch(e){}
      setInterval(async ()=>{
        try{ await fetchPresence(); }catch(e){}
      }, PRESENCE_POLL_MS);
    }catch(err){
      document.getElementById('doctorList').innerHTML =
        '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Failed to load doctors. Please try again.</p></div>';
      console.error(err);
    }
  })();
</script>
</body>
</html>
