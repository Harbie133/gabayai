<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emergency Contacts - GabayAI</title>
  <link rel="stylesheet" href="navbar.css" />
  <link rel="stylesheet" href="emergencycontacts.css" />
</head>
<body>

  <!-- Custom Modal -->
  <div class="custom-modal-overlay" id="customModal">
    <div class="custom-modal">
      <div class="custom-modal-header">
        <div class="custom-modal-icon" id="modalIcon">
          <span id="modalIconSymbol">?</span>
        </div>
        <h3 class="custom-modal-title" id="modalTitle">Confirm Action</h3>
      </div>
      <p class="custom-modal-message" id="modalMessage"></p>
      <div class="custom-modal-buttons">
        <button class="custom-modal-btn custom-modal-btn-cancel" id="modalCancelBtn">Cancel</button>
        <button class="custom-modal-btn custom-modal-btn-confirm" id="modalConfirmBtn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- <CHANGE> Added responsive navbar -->
<nav class="navbar">
  <div class="navbar-container">
    <a href="homer.html" class="navbar-logo">GabayAI</a>
    <ul class="navbar-nav"> 
      <li><a href="homer.html" class="nav-link ">Dashboard</a></li>
      <li><a href="analyzer.html" class="nav-link ">Analyzer</a></li>
      <li><a href="consult.html" class="nav-link ">Consultation</a></li>
      <li><a href="profile.html" class="nav-link active">Profile</a></li>
      <li>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </button>
      </li>
    </ul>

    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
      <div class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </button>
  </div>

  <div class="mobile-menu" id="mobileMenu">
    <div class="mobile-menu-items">
      <a href="homer.html" class="mobile-nav-link ">Dashboard</a>
      <a href="analyzer.html" class="mobile-nav-link ">Analyzer</a>
      <a href="consult.html" class="mobile-nav-link ">Consultation</a>
      <a href="profile.html" class="mobile-nav-link active">Profile</a>
      
      <!-- Mobile Logout Button -->
      <div class="mobile-logout">
        <button onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </button>
      </div>
    </div>
  </div>
</nav>

  <div class="container">
    <h2>Emergency Contacts</h2>
    
    <div class="success-message" id="successMessage"></div>

    <form id="emergencyContactsForm" novalidate>
      <input type="hidden" id="contactId" name="contactId" value="">
      
      <div class="form-grid">
        <div class="form-group">
          <label for="contactName">Contact Name *</label>
          <input type="text" id="contactName" name="contactName" placeholder="Enter full name" required />
          <div class="error-message" id="contactNameError">Please enter the contact's name.</div>
        </div>

        <div class="form-group">
          <label for="relationship">Relationship *</label>
          <select id="relationship" name="relationship" required>
            <option value="">Select relationship</option>
            <option value="Spouse/Partner">Spouse/Partner</option>
            <option value="Parent">Parent</option>
            <option value="Sibling">Sibling</option>
            <option value="Child">Child</option>
            <option value="Friend">Friend</option>
            <option value="Legal Guardian">Legal Guardian</option>
          </select>
          <div class="error-message" id="relationshipError">Please select the relationship.</div>
        </div>

        <div class="form-group">
          <label for="contactNumber">Primary Phone</label>
          <input type="tel" id="contactNumber" name="contactNumber" placeholder="09XX-XXX-XXXX" />
          <div class="error-message" id="contactNumberError">Please enter a valid contact number.</div>
        </div>

        <div class="form-group">
          <label for="alternateNumber">Alternate Phone</label>
          <input type="tel" id="alternateNumber" name="alternateNumber" placeholder="Optional" />
        </div>

        <div class="form-group full-width">
          <label for="email">Email Address</label>
          <input type="email" id="email" name="email" placeholder="contact@example.com" />
          <div class="help-text">* At least one contact method (phone or email) is required</div>
          <div class="error-message" id="emailError">Please enter a valid email address.</div>
        </div>

        <div class="form-group full-width">
          <label for="address">Address</label>
          <input type="text" id="address" name="address" placeholder="Complete address (optional)" />
        </div>
      </div>

      <div class="btn-group">
        <button type="submit" id="submitBtn">Save Contact</button>
        <button type="button" class="btn-cancel" onclick="resetForm()">Cancel</button>
      </div>
    </form>

    <div class="contacts-list">
      <h3>Saved Emergency Contacts</h3>
      <div class="contact-counter" id="contactCounter">0 of 5 contacts added</div>
      <div id="contactsContainer">
        <div class="no-contacts">No emergency contacts added yet.</div>
      </div>
    </div>
  </div>

  <script src="auth-guard.js"></script>

  <script>

    // User logout function (only clears user sessions, not doctor sessions)
function logout() {
    if (confirm('Are you sure you want to logout?')) {
        window.location.href = 'user_logout.php';
    }
}

// FIXED: Mobile menu toggle - now uses 'show' class instead of 'active'
function toggleMobileMenu() {
    const mobileMenu = document.getElementById('mobileMenu');
    const hamburger = document.getElementById('hamburger');
    mobileMenu.classList.toggle('show');  // Changed from 'active' to 'show'
    hamburger.classList.toggle('open');   // Changed from 'active' to 'open'
}

// Close mobile menu when clicking outside
document.addEventListener('click', function(e) {
    const mobileMenu = document.getElementById('mobileMenu');
    const hamburger = document.getElementById('hamburger');
    
    if (!e.target.closest('.mobile-menu-btn') && !e.target.closest('.mobile-menu')) {
        if (mobileMenu.classList.contains('show')) {
            mobileMenu.classList.remove('show');
            hamburger.classList.remove('open');
        }
    }
});



    const form = document.getElementById('emergencyContactsForm');
    const contactsContainer = document.getElementById('contactsContainer');
    const successMessage = document.getElementById('successMessage');
    const contactCounter = document.getElementById('contactCounter');

    // Form fields
    const contactId = document.getElementById('contactId');
    const contactName = document.getElementById('contactName');
    const relationship = document.getElementById('relationship');
    const contactNumber = document.getElementById('contactNumber');
    const alternateNumber = document.getElementById('alternateNumber');
    const email = document.getElementById('email');
    const address = document.getElementById('address');
    const submitBtn = document.getElementById('submitBtn');

    // Error messages
    const contactNameError = document.getElementById('contactNameError');
    const relationshipError = document.getElementById('relationshipError');
    const contactNumberError = document.getElementById('contactNumberError');
    const emailError = document.getElementById('emailError');

    // Contact limits
    const MAX_CONTACTS = 5;
    let currentContactCount = 0;

    // Custom Modal Elements
    const customModal = document.getElementById('customModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalIcon = document.getElementById('modalIcon');
    const modalIconSymbol = document.getElementById('modalIconSymbol');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');

    // Custom Confirm Function
    function customConfirm(message, title = 'Confirm Action', type = 'info') {
      return new Promise((resolve) => {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        
        // Set icon based on type
        modalIcon.className = 'custom-modal-icon ' + type;
        if (type === 'info') {
          modalIconSymbol.textContent = '?';
        } else if (type === 'warning') {
          modalIconSymbol.textContent = 'âš ';
        } else if (type === 'danger') {
          modalIconSymbol.textContent = 'ðŸ—‘';
        }
        
        // Set button style for delete actions
        if (type === 'danger') {
          modalConfirmBtn.className = 'custom-modal-btn custom-modal-btn-delete';
          modalConfirmBtn.textContent = 'Delete';
        } else {
          modalConfirmBtn.className = 'custom-modal-btn custom-modal-btn-confirm';
          modalConfirmBtn.textContent = 'Confirm';
        }
        
        customModal.classList.add('active');
        
        const handleConfirm = () => {
          customModal.classList.remove('active');
          modalConfirmBtn.removeEventListener('click', handleConfirm);
          modalCancelBtn.removeEventListener('click', handleCancel);
          resolve(true);
        };
        
        const handleCancel = () => {
          customModal.classList.remove('active');
          modalConfirmBtn.removeEventListener('click', handleConfirm);
          modalCancelBtn.removeEventListener('click', handleCancel);
          resolve(false);
        };
        
        modalConfirmBtn.addEventListener('click', handleConfirm);
        modalCancelBtn.addEventListener('click', handleCancel);
        
        // Close on overlay click
        customModal.addEventListener('click', function(e) {
          if (e.target === customModal) {
            handleCancel();
          }
        });
      });
    }

    // Load contacts on page load
    document.addEventListener('DOMContentLoaded', loadContacts);

    function resetErrors() {
      [contactName, relationship, contactNumber, email].forEach(input => 
        input.classList.remove('invalid')
      );
      [contactNameError, relationshipError, contactNumberError, emailError].forEach(err => 
        err.style.display = 'none'
      );
    }

    function validatePhone(phone) {
      if (!phone) return true;
      const phonePattern = /^(09|\+639)\d{9}$/;
      return phonePattern.test(phone.replace(/[-\s]/g, ''));
    }

    function validateEmail(emailValue) {
      if (!emailValue) return true;
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailPattern.test(emailValue);
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      setTimeout(() => {
        successMessage.style.display = 'none';
      }, 3000);
    }

    function updateContactCounter(count) {
      currentContactCount = count;
      contactCounter.textContent = `${count} of ${MAX_CONTACTS} contacts added`;
      
      if (!contactId.value) {
        if (count >= MAX_CONTACTS) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Maximum Contacts Reached';
        } else {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Save Contact';
        }
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      resetErrors();

      if (!contactId.value && currentContactCount >= MAX_CONTACTS) {
        alert(`You cannot add more than ${MAX_CONTACTS} emergency contacts.`);
        return;
      }

      let valid = true;

      if (!contactName.value.trim()) {
        contactName.classList.add('invalid');
        contactNameError.style.display = 'block';
        valid = false;
      }

      if (!relationship.value) {
        relationship.classList.add('invalid');
        relationshipError.style.display = 'block';
        valid = false;
      }

      const hasPhone = contactNumber.value.trim();
      const hasEmail = email.value.trim();

      if (!hasPhone && !hasEmail) {
        contactNumber.classList.add('invalid');
        email.classList.add('invalid');
        contactNumberError.textContent = 'Please provide either a phone number or email address.';
        contactNumberError.style.display = 'block';
        emailError.textContent = 'Please provide either a phone number or email address.';
        emailError.style.display = 'block';
        valid = false;
      } else {
        if (hasPhone && !validatePhone(contactNumber.value)) {
          contactNumber.classList.add('invalid');
          contactNumberError.textContent = 'Please enter a valid Philippine phone number.';
          contactNumberError.style.display = 'block';
          valid = false;
        }

        if (hasEmail && !validateEmail(email.value)) {
          email.classList.add('invalid');
          emailError.textContent = 'Please enter a valid email address.';
          emailError.style.display = 'block';
          valid = false;
        }
      }

      if (valid) {
        const action = contactId.value ? 'update' : 'add';
        const confirmTitle = action === 'add' ? 'Add Emergency Contact' : 'Update Emergency Contact';
        const confirmMessage = action === 'add' 
          ? `Do you want to add ${contactName.value.trim()} as an emergency contact?`
          : `Do you want to update the contact information for ${contactName.value.trim()}?`;

        const confirmed = await customConfirm(confirmMessage, confirmTitle, 'info');
        
        if (confirmed) {
          const formData = new FormData(form);
          formData.append('action', action);

          fetch('emergency_contacts_handler.php', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showSuccess(data.message);
              resetForm();
              loadContacts();
            } else {
              alert('Error: ' + data.message);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
          });
        }
      }
    });

    function resetForm() {
      form.reset();
      contactId.value = '';
      submitBtn.textContent = 'Save Contact';
      submitBtn.disabled = currentContactCount >= MAX_CONTACTS;
      resetErrors();
    }

    function loadContacts() {
      fetch('emergency_contacts_handler.php?action=get')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.contacts.length > 0) {
            displayContacts(data.contacts);
            updateContactCounter(data.contacts.length);
          } else {
            contactsContainer.innerHTML = '<div class="no-contacts">No emergency contacts added yet.</div>';
            updateContactCounter(0);
          }
        })
        .catch(error => {
          console.error('Error loading contacts:', error);
        });
    }

    function displayContacts(contacts) {
      contactsContainer.innerHTML = contacts.map(contact => `
        <div class="contact-card">
          <div class="contact-info">
            <div class="contact-info-item">
              <label>Name</label>
              <span>${contact.contact_name}</span>
            </div>
            <div class="contact-info-item">
              <label>Relationship</label>
              <span>${contact.relationship}</span>
            </div>
            ${contact.contact_number ? `
            <div class="contact-info-item">
              <label>Primary Phone</label>
              <span>${contact.contact_number}</span>
            </div>
            ` : ''}
            ${contact.alternate_number ? `
            <div class="contact-info-item">
              <label>Alternate Phone</label>
              <span>${contact.alternate_number}</span>
            </div>
            ` : ''}
            ${contact.email ? `
            <div class="contact-info-item">
              <label>Email</label>
              <span>${contact.email}</span>
            </div>
            ` : ''}
            ${contact.address ? `
            <div class="contact-info-item">
              <label>Address</label>
              <span>${contact.address}</span>
            </div>
            ` : ''}
          </div>
          <div class="contact-actions">
            <button class="btn-edit" onclick="editContact(${contact.id})">Edit</button>
            <button class="btn-delete" onclick="deleteContact(${contact.id})">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function editContact(id) {
      fetch(`emergency_contacts_handler.php?action=get&id=${id}`)
        .then(response => response.json())
        .then(data => {
          if (data.success && data.contact) {
            const contact = data.contact;
            contactId.value = contact.id;
            contactName.value = contact.contact_name;
            relationship.value = contact.relationship;
            contactNumber.value = contact.contact_number || '';
            alternateNumber.value = contact.alternate_number || '';
            email.value = contact.email || '';
            address.value = contact.address || '';
            submitBtn.textContent = 'Update Contact';
            submitBtn.disabled = false;
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error loading contact details.');
        });
    }

    async function deleteContact(id) {
      const confirmed = await customConfirm(
        'Are you sure you want to delete this emergency contact? This action cannot be undone.',
        'Delete Contact',
        'danger'
      );
      
      if (confirmed) {
        const formData = new FormData();
        formData.append('action', 'delete');
        formData.append('id', id);

        fetch('emergency_contacts_handler.php', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showSuccess('Contact deleted successfully!');
            loadContacts();
          } else {
            alert('Error: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred. Please try again.');
        });
      }
    }
  </script>

</body>
</html>
