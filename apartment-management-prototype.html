<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Apartment Management — Prototype</title>
<style>
  /* ---------- Reset & base ---------- */
  :root{
    --bg:#f5f7fb; --card:#ffffff; --muted:#6b7280; --accent:#2563eb;
    --success:#16a34a; --danger:#dc2626; --glass: rgba(255,255,255,0.6);
    --shadow: 0 6px 20px rgba(20,20,40,0.06);
    --radius:12px; --mono: 'Segoe UI', Roboto, Arial, sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:var(--mono);background:linear-gradient(180deg,#eef2ff 0,#f5f7fb 100%);
    color:#0f172a; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    padding:24px;
  }
  .app{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:320px 1fr;gap:20px;align-items:start}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  h1{font-size:20px;margin:0}
  .sub{color:var(--muted);font-size:13px}
  /* ---------- Sidebar ---------- */
  .sidebar .logo{display:flex;gap:10px;align-items:center}
  .logo .badge{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  nav{margin-top:18px;display:flex;flex-direction:column;gap:8px}
  nav button{background:transparent;border:0;padding:10px 12px;text-align:left;border-radius:10px;color:#0f172a;cursor:pointer}
  nav button.active{background:linear-gradient(90deg, rgba(37,99,235,0.12), rgba(124,58,237,0.06));box-shadow:inset 0 0 0 1px rgba(37,99,235,0.04)}
  .tiny{font-size:12px;color:var(--muted)}
  .muted{color:var(--muted)}
  /* ---------- Main area ---------- */
  .top-controls{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .search{display:flex;gap:8px;align-items:center}
  .search input{padding:10px 12px;border-radius:10px;border:1px solid #e6e9f0;min-width:260px}
  .btn{background:var(--accent);color:white;padding:10px 12px;border-radius:10px;border:0;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--accent);box-shadow:none;border:1px solid rgba(37,99,235,0.12)}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px}
  .stat{display:flex;flex-direction:column;gap:6px;padding:14px;border-radius:12px;background:linear-gradient(180deg,#ffffff,#fbfcff)}
  .stat .num{font-weight:700;font-size:20px}
  /* ---------- listings / table ---------- */
  .listings{margin-top:12px;display:grid;gap:12px}
  .listing{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;border:1px solid #eef2ff}
  .listing .image{width:110px;height:70px;border-radius:8px;background:#e6eefc;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px}
  .listing .meta{flex:1}
  .pill{display:inline-block;padding:6px 8px;border-radius:999px;font-size:12px}
  .pill.available{background:#ecfdf5;color:var(--success);border:1px solid rgba(16,185,129,0.08)}
  .pill.occupied{background:#fff7ed;color:#92400e;border:1px solid rgba(252,211,77,0.08)}
  .small{font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;text-align:left;border-bottom:1px solid #f0f3fa}
  th{font-size:13px;color:var(--muted)}
  /* ---------- modals & forms ---------- */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(6,6,23,0.35);z-index:1000}
  .modal.open{display:flex}
  .modal .panel{width:920px;max-width:95%;background:var(--card);padding:18px;border-radius:12px;box-shadow:var(--shadow)}
  label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
  input, select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9f0}
  .form-row{display:flex;gap:12px}
  .form-row > *{flex:1}
  .flex{display:flex;gap:10px;align-items:center}
  .right{margin-left:auto}
  .notice{background:#fffbeb;border-left:4px solid #f59e0b;padding:10px;border-radius:8px;color:#92400e}
  /* ---------- responsive ---------- */
  @media (max-width:1000px){ .app{grid-template-columns:1fr} header{flex-direction:column;align-items:flex-start;gap:12px} .grid-3{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:600px){ .grid-3{grid-template-columns:1fr} .search input{min-width:140px} nav{display:flex;flex-direction:row;gap:6px;overflow:auto} .sidebar{order:2} .main{order:1} }
  footer{grid-column:1/-1;margin-top:12px;font-size:12px;color:var(--muted);text-align:center}
  /* small helpers */
  .muted-2{color:#94a3b8;font-size:12px}
  .tag{background:#f3f4f6;padding:6px;border-radius:8px;font-size:12px}
  .danger{color:var(--danger)}
</style>
</head>
<body>
<div class="app">

  <!-- header -->
  <header>
    <div>
      <h1>Casa de Belle — Apartment Management (Prototype)</h1>
      <div class="sub">E-Market platform for seamless leasing & tenant management</div>
    </div>
    <div class="flex">
      <div class="muted-2" id="current-user">Visitor</div>
      <button class="btn ghost" onclick="openModal('login')">Sign in</button>
    </div>
  </header>

  <!-- sidebar -->
  <aside class="sidebar card">
    <div class="logo">
      <div class="badge">CB</div>
      <div>
        <div style="font-weight:700">Casa de Belle</div>
        <div class="tiny">Owner / Admin demo</div>
      </div>
    </div>

    <nav id="main-nav">
      <button class="active" data-view="dashboard" onclick="switchView(event)">Dashboard</button>
      <button data-view="listings" onclick="switchView(event)">Listings</button>
      <button data-view="tenants" onclick="switchView(event)">Tenants</button>
      <button data-view="maintenance" onclick="switchView(event)">Maintenance</button>
      <button data-view="reports" onclick="switchView(event)">Reports</button>
      <button data-view="settings" onclick="switchView(event)">Settings</button>
    </nav>

    <hr style="margin:12px 0;border:0;height:1px;background:#f0f3fa;border-radius:4px" />
    <div class="tiny">Quick actions</div>
    <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
      <button class="btn" onclick="openModal('addListing')">+ Add Listing</button>
      <button class="btn ghost" onclick="openModal('addTenant')">+ Add Tenant</button>
      <button class="btn ghost" onclick="simulateReminder()">Run Reminders</button>
    </div>
  </aside>

  <!-- main -->
  <main class="main card" id="main-card">
    <!-- top controls -->
    <div class="top-controls">
      <div class="search">
        <input id="globalSearch" placeholder="Search apartments, tenants, contracts..." oninput="renderActiveView()" />
        <select id="filterStatus" onchange="renderActiveView()">
          <option value="">All status</option>
          <option value="available">Available</option>
          <option value="occupied">Occupied</option>
        </select>
        <select id="filterSort" onchange="renderActiveView()">
          <option value="newest">Sort: Newest</option>
          <option value="price-asc">Price ↑</option>
          <option value="price-desc">Price ↓</option>
        </select>
      </div>

      <div>
        <span class="tag">Demo mode — data saved in localStorage</span>
      </div>
    </div>

    <!-- dynamic content area -->
    <section id="view-area" style="margin-top:16px">
      <!-- dashboard view default -->
      <div id="view-dashboard" class="view">
        <div class="grid-3">
          <div class="stat">
            <div class="small">Monthly earnings (est.)</div>
            <div class="num" id="stat-earnings">₱0</div>
            <div class="muted small">Based on active leases this month</div>
          </div>
          <div class="stat">
            <div class="small">Units</div>
            <div class="num" id="stat-units">0</div>
            <div class="muted small">Available / Occupied</div>
          </div>
          <div class="stat">
            <div class="small">Maintenance tickets</div>
            <div class="num" id="stat-maint">0</div>
            <div class="muted small">Open / Resolved</div>
          </div>
        </div>

        <div style="margin-top:12px" class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <strong>Recent activity</strong>
              <div class="muted small">Latest bookings, payments, and maintenance notes</div>
            </div>
            <div class="tiny muted">Auto-updates from demo actions</div>
          </div>

          <div id="activity-feed" style="margin-top:12px;display:flex;flex-direction:column;gap:8px"></div>
        </div>

        <div style="margin-top:12px" class="card">
          <strong>Quick summary</strong>
          <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
            <div class="pill available">Available</div>
            <div class="pill occupied">Occupied</div>
            <div class="tag">Notifications: <span id="notif-count">0</span></div>
            <div class="tag">Tenants: <span id="stat-tenants">0</span></div>
          </div>
        </div>
      </div>

      <!-- listings -->
      <div id="view-listings" class="view" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <strong>Apartment Listings</strong>
            <div class="muted small">Manage units: add photos, price, availability & book</div>
          </div>
          <div>
            <button class="btn" onclick="openModal('addListing')">+ Add Listing</button>
          </div>
        </div>

        <div id="listings-area" class="listings"></div>

        <div style="margin-top:12px">
          <strong>All units (table)</strong>
          <table style="margin-top:8px">
            <thead><tr><th>Unit</th><th>Price</th><th>Occupancy</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="units-table"></tbody>
          </table>
        </div>
      </div>

      <!-- tenants -->
      <div id="view-tenants" class="view" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>Tenants</strong>
            <div class="muted small">Manage tenant profiles and lease details</div>
          </div>
          <div>
            <button class="btn" onclick="openModal('addTenant')">+ Add Tenant</button>
          </div>
        </div>

        <div id="tenants-area" style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px"></div>
      </div>

      <!-- maintenance -->
      <div id="view-maintenance" class="view" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>Maintenance</strong>
            <div class="muted small">Track and resolve maintenance requests</div>
          </div>
          <div>
            <button class="btn ghost" onclick="openModal('addMaintenance')">+ Add Ticket</button>
          </div>
        </div>

        <div id="maintenance-area" style="margin-top:12px;display:flex;flex-direction:column;gap:8px"></div>
      </div>

      <!-- reports -->
      <div id="view-reports" class="view" style="display:none">
        <strong>Reports</strong>
        <div class="muted small">Sample analytics and export options (mock)</div>

        <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
          <div class="card" style="flex:1;min-width:220px">
            <div class="small">Occupancy rate</div>
            <div style="font-size:22px;margin-top:6px" id="report-occupancy">0%</div>
            <div class="muted small">Occupied vs total units</div>
          </div>
          <div class="card" style="flex:1;min-width:220px">
            <div class="small">Projected monthly income</div>
            <div style="font-size:22px;margin-top:6px" id="report-income">₱0</div>
            <div class="muted small">From active leases</div>
          </div>
        </div>
      </div>

      <!-- settings -->
      <div id="view-settings" class="view" style="display:none">
        <strong>Settings</strong>
        <div class="muted small">Demo settings: manage demo users & reset data</div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn ghost" onclick="resetDemo()">Reset demo data</button>
          <button class="btn" onclick="downloadData()">Export demo data (.json)</button>
        </div>
      </div>
    </section>

  </main>

  <footer class="muted small">Prototype built for capstone visualization — not a production system. Data persists locally in your browser.</footer>
</div>

<!-- ---------- Modals ---------- -->
<div id="modal-login" class="modal" aria-hidden="true">
  <div class="panel">
    <h3>Sign in (demo)</h3>
    <div class="muted small">Use demo credentials: <strong>owner@example.com</strong> or <strong>admin@example.com</strong></div>
    <div style="margin-top:12px">
      <label>Email</label>
      <input id="login-email" placeholder="owner@example.com" />
      <label style="margin-top:8px">Password</label>
      <input id="login-pass" placeholder="demo" />
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" onclick="doLogin()">Sign in</button>
        <button class="btn ghost" onclick="closeModal('login')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div id="modal-addListing" class="modal">
  <div class="panel">
    <h3 id="listing-modal-title">Add Listing</h3>
    <form id="listing-form" onsubmit="event.preventDefault();saveListing();">
      <div class="form-row">
        <div>
          <label>Unit name / no.</label>
          <input id="listing-unit" required />
        </div>
        <div>
          <label>Price (₱ / month)</label>
          <input id="listing-price" type="number" required />
        </div>
      </div>

      <div style="margin-top:8px" class="form-row">
        <div>
          <label>Occupancy limit</label>
          <input id="listing-capacity" type="number" value="1" min="1" />
        </div>
        <div>
          <label>Status</label>
          <select id="listing-status"><option value="available">Available</option><option value="occupied">Occupied</option></select>
        </div>
      </div>

      <div style="margin-top:8px">
        <label>Amenities / notes</label>
        <textarea id="listing-notes" rows="2"></textarea>
      </div>

      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <div>
          <label>Fake photo name (demo)</label>
          <input id="listing-photo" placeholder="room1.jpg" />
        </div>
        <div class="right">
          <button class="btn" type="submit">Save</button>
          <button type="button" class="btn ghost" onclick="closeModal('addListing')">Close</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div id="modal-addTenant" class="modal">
  <div class="panel">
    <h3>Add Tenant</h3>
    <form id="tenant-form" onsubmit="event.preventDefault();saveTenant();">
      <div class="form-row">
        <div>
          <label>Full name</label>
          <input id="tenant-name" required />
        </div>
        <div>
          <label>Contact / phone</label>
          <input id="tenant-phone" />
        </div>
      </div>

      <div style="margin-top:8px" class="form-row">
        <div>
          <label>Assigned unit (optional)</label>
          <select id="tenant-unit"><option value="">-- none --</option></select>
        </div>
        <div>
          <label>Monthly rent (₱)</label>
          <input id="tenant-rent" type="number" />
        </div>
      </div>

      <div style="margin-top:8px" class="form-row">
        <div>
          <label>Lease start</label>
          <input id="tenant-start" type="date" />
        </div>
        <div>
          <label>Lease end</label>
          <input id="tenant-end" type="date" />
        </div>
      </div>

      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <div style="flex:1"><label>Upload contract (mock)</label><input id="tenant-contract" placeholder="contract.pdf" /></div>
        <div class="right">
          <button class="btn" type="submit">Save Tenant</button>
          <button type="button" class="btn ghost" onclick="closeModal('addTenant')">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div id="modal-maint" class="modal">
  <div class="panel">
    <h3>Add Maintenance Ticket</h3>
    <form onsubmit="event.preventDefault();saveMaintenance();">
      <label>Unit</label>
      <select id="maint-unit"></select>
      <label style="margin-top:8px">Issue details</label>
      <textarea id="maint-details" rows="3"></textarea>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" type="submit">Create Ticket</button>
        <button class="btn ghost" type="button" onclick="closeModal('addMaintenance')">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- ---------- Templates & scripts ---------- -->
<script>
/* ---------------------------------------------------
   Minimal client-side "backend" using localStorage
   --------------------------------------------------- */

const STORAGE_KEY = 'apm-demo-v1';
const demoUsers = [
  {role:'owner',email:'owner@example.com',name:'Owner Demo',pass:'demo'},
  {role:'admin',email:'admin@example.com',name:'Admin Demo',pass:'demo'}
];
let state = {
  currentUser: null,
  apartments: [], // {id,unit,price,capacity,status,notes,photo}
  tenants: [],    // {id,name,phone,unit,rent,start,end,contract}
  maintenance: [],// {id,unit,details,status,created}
  activity: [],   // simple activity feed
  notifications: []
};

/* ----------------- init ----------------- */
function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    try{ state = JSON.parse(raw); } catch(e){ console.warn('load error',e); localStorage.removeItem(STORAGE_KEY) }
  } else {
    // seed demo data
    state.apartments = [
      createApt('Unit 1A',8000,1,'available','Cozy single room','room1.jpg'),
      createApt('Unit 1B',9000,1,'occupied','Near stairs','room2.jpg'),
      createApt('Unit 2A',15000,2,'available','Large 2-bed','room3.jpg')
    ];
    state.tenants = [
      createTenant('Juan Dela Cruz','09171234567','Unit 1B',9000,'2025-07-01','2026-06-30','lease-1.pdf')
    ];
    state.maintenance = [
      createMaint('Unit 1B','Leaky faucet in kitchen','open')
    ];
    state.activity = [
      makeActivity('Seeded demo apartments and tenant'),
      makeActivity('Maintenance ticket created: Unit 1B')
    ];
    saveState();
  }
  refreshUI();
}
function saveState(){ localStorage.setItem(STORAGE_KEY,JSON.stringify(state)); updateSyntheticCounts(); }

/* ----------------- creators ----------------- */
function createId(prefix='id'){return prefix+'-'+Math.random().toString(36).slice(2,9)}
function createApt(unit,price,cap,status,notes,photo){
  return {id:createId('apt'),unit,price:Number(price),capacity:cap,status,notes,photo};
}
function createTenant(name,phone,unit,rent,start,end,contract){
  return {id:createId('t'),name,phone,unit,rent:rent?Number(rent):0,start,end,contract};
}
function createMaint(unit,details,status='open'){
  return {id:createId('m'),unit,details,status,created:new Date().toISOString()};
}
function makeActivity(text){ return {id:createId('a'),text,time:new Date().toISOString()} }

/* ----------------- UI helpers ----------------- */
function refreshUI(){
  document.getElementById('current-user').textContent = state.currentUser ? state.currentUser.name+' ('+state.currentUser.role+')' : 'Visitor';
  renderActiveView();
  renderStats();
  saveState();
}
function renderActiveView(){
  const views = document.querySelectorAll('.view');
  views.forEach(v=>v.style.display='none');
  const navBtns = document.querySelectorAll('#main-nav button');
  navBtns.forEach(b=>b.classList.remove('active'));
  const active = document.querySelector('#main-nav button.active') || navBtns[0];
  if(!active) return;
  active.classList.add('active');
  const view = active.dataset.view || 'dashboard';
  document.getElementById('view-'+view).style.display='block';

  // render content based on view
  if(view==='dashboard'){ renderActivity(); }
  if(view==='listings'){ renderListings(); renderUnitsTable(); }
  if(view==='tenants'){ renderTenants(); }
  if(view==='maintenance'){ renderMaintenance(); }
  if(view==='reports'){ renderReports(); }
}
function switchView(evt){
  document.querySelectorAll('#main-nav button').forEach(b=>b.classList.remove('active'));
  evt.target.classList.add('active');
  renderActiveView();
}

/* ----------------- render components ----------------- */
function renderListings(){
  const area = document.getElementById('listings-area'); area.innerHTML='';
  const q = document.getElementById('globalSearch').value.toLowerCase();
  const statusFilter = document.getElementById('filterStatus').value;
  const sort = document.getElementById('filterSort').value;

  let items = state.apartments.slice();
  if(statusFilter) items = items.filter(i=>i.status===statusFilter);
  if(q) items = items.filter(i=> (i.unit||'').toLowerCase().includes(q) || (i.notes||'').toLowerCase().includes(q) );

  if(sort==='price-asc') items.sort((a,b)=>a.price-b.price);
  if(sort==='price-desc') items.sort((a,b)=>b.price-a.price);

  items.forEach(i=>{
    const div = document.createElement('div'); div.className='listing';
    div.innerHTML = `
      <div class="image">${i.photo||'photo'}</div>
      <div class="meta">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${i.unit}</strong><div class="small">${i.notes||''}</div></div>
          <div style="text-align:right">
            <div style="font-weight:700">₱ ${formatNum(i.price)}</div>
            <div class="small">Cap: ${i.capacity}</div>
          </div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <div class="pill ${i.status==='available'?'available':'occupied'}">${i.status}</div>
          <button class="btn ghost" onclick='editListing("${i.id}")'>Edit</button>
          <button class="btn ghost" onclick='deleteListing("${i.id}")'>Delete</button>
          ${i.status==='available' ? `<button class="btn" onclick='bookUnit("${i.id}")'>Book / Rent</button>` : ''}
        </div>
      </div>
    `;
    area.appendChild(div);
  });

  if(items.length===0) area.innerHTML = '<div class="muted small">No units found.</div>';
}

function renderUnitsTable(){
  const tbody = document.getElementById('units-table'); tbody.innerHTML='';
  state.apartments.forEach(a=>{
    const tr = document.createElement('tr');
    const occ = state.tenants.filter(t=>t.unit===a.unit).length;
    tr.innerHTML = `<td><strong>${a.unit}</strong><div class="small">${a.notes||''}</div></td>
      <td>₱ ${formatNum(a.price)}</td>
      <td>${occ}/${a.capacity}</td>
      <td>${a.status}</td>
      <td>
        <button class="btn ghost" onclick='editListing("${a.id}")'>Edit</button>
        <button class="btn ghost" onclick='deleteListing("${a.id}")'>Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function renderTenants(){
  const area = document.getElementById('tenants-area'); area.innerHTML='';
  const q = document.getElementById('globalSearch').value.toLowerCase();
  const list = state.tenants.filter(t=>!q || (t.name||'').toLowerCase().includes(q) || (t.unit||'').toLowerCase().includes(q) );
  list.forEach(t=>{
    const card = document.createElement('div'); card.className='card';
    const daysLeft = t.end ? daysBetween(new Date(), new Date(t.end)) : '—';
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>${t.name}</strong>
          <div class="muted small">${t.phone || ''}</div>
          <div class="muted small">Unit: ${t.unit || '—'}</div>
        </div>
        <div style="text-align:right">
          <div>₱ ${formatNum(t.rent||0)}</div>
          <div class="small">Lease ends in: ${typeof daysLeft==='number'?daysLeft + ' days':daysLeft}</div>
        </div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn ghost" onclick='viewTenant("${t.id}")'>View</button>
        <button class="btn ghost" onclick='deleteTenant("${t.id}")'>Remove</button>
      </div>
    `;
    area.appendChild(card);
  });
  document.getElementById('stat-tenants').textContent = state.tenants.length;
}

function renderMaintenance(){
  const area = document.getElementById('maintenance-area'); area.innerHTML='';
  state.maintenance.forEach(m=>{
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>${m.unit}</strong>
          <div class="muted small">${m.details}</div>
          <div class="muted small">Created: ${new Date(m.created).toLocaleString()}</div>
        </div>
        <div style="text-align:right">
          <div class="small">Status: <strong>${m.status}</strong></div>
          <div style="margin-top:8px;display:flex;gap:8px">
            ${m.status === 'open' ? `<button class="btn" onclick='resolveTicket("${m.id}")'>Mark resolved</button>` : ''}
            <button class="btn ghost" onclick='deleteMaintenance("${m.id}")'>Delete</button>
          </div>
        </div>
      </div>
    `;
    area.appendChild(el);
  });
  document.getElementById('stat-maint').textContent = state.maintenance.filter(m=>m.status==='open').length + ' / ' + state.maintenance.length;
}

function renderActivity(){
  const feed = document.getElementById('activity-feed'); feed.innerHTML='';
  state.activity.slice().reverse().slice(0,8).forEach(a=>{
    const d = document.createElement('div'); d.className='small muted';
    d.textContent = `${new Date(a.time).toLocaleString()} — ${a.text}`;
    feed.appendChild(d);
  });
}

/* ----------------- reports & stats ----------------- */
function renderStats(){
  const earnings = state.tenants.reduce((s,t)=>s + (Number(t.rent)||0),0);
  document.getElementById('stat-earnings').textContent = '₱ ' + formatNum(earnings);
  document.getElementById('stat-units').textContent = `${state.apartments.length}`;
  document.getElementById('report-income').textContent = '₱ ' + formatNum(earnings);
  const occupied = state.apartments.filter(a=>a.status==='occupied').length;
  const occRate = state.apartments.length ? Math.round((occupied/state.apartments.length)*100) : 0;
  document.getElementById('report-occupancy').textContent = occRate + '%';
  document.getElementById('notif-count').textContent = state.notifications.length;
}

/* ----------------- actions ----------------- */
function openModal(name){
  closeAllModals();
  const el = document.getElementById('modal-'+(name==='addListing'?'addListing':name));
  if(name==='addListing') {
    document.getElementById('listing-modal-title').textContent = 'Add Listing';
    document.getElementById('listing-form').dataset.editId = '';
  }
  if(name==='addTenant'){
    populateUnitOptions('tenant-unit');
    document.getElementById('tenant-form').dataset.editId = '';
  }
  if(name==='addMaintenance'){
    populateUnitOptions('maint-unit');
  }
  if(el) el.classList.add('open');
  // prefill some for quick demo
  if(name==='login'){ document.getElementById('login-email').value = 'owner@example.com'; document.getElementById('login-pass').value='demo' }
}
function closeModal(name){
  const el = document.getElementById('modal-'+(name==='login'?'login': name));
  if(el) el.classList.remove('open');
}
function closeAllModals(){ document.querySelectorAll('.modal.open').forEach(m=>m.classList.remove('open')); }

/* ---------- Listing CRUD ---------- */
function saveListing(){
  const id = document.getElementById('listing-form').dataset.editId;
  const unit = document.getElementById('listing-unit').value.trim();
  const price = Number(document.getElementById('listing-price').value);
  const capacity = Number(document.getElementById('listing-capacity').value) || 1;
  const status = document.getElementById('listing-status').value;
  const notes = document.getElementById('listing-notes').value;
  const photo = document.getElementById('listing-photo').value || '';

  if(!unit || !price){ alert('Please fill required fields'); return; }

  if(id){
    const idx = state.apartments.findIndex(a=>a.id===id);
    if(idx>=0){ Object.assign(state.apartments[idx],{unit,price,capacity,status,notes,photo}); state.activity.push(makeActivity('Updated listing: '+unit)); }
  } else {
    state.apartments.push(createApt(unit,price,capacity,status,notes,photo));
    state.activity.push(makeActivity('Added listing: '+unit));
  }
  saveState();
  closeModal('addListing');
  renderActiveView();
}

function editListing(id){
  const a = state.apartments.find(x=>x.id===id); if(!a) return;
  openModal('addListing');
  document.getElementById('listing-modal-title').textContent = 'Edit Listing';
  document.getElementById('listing-form').dataset.editId = id;
  document.getElementById('listing-unit').value = a.unit;
  document.getElementById('listing-price').value = a.price;
  document.getElementById('listing-capacity').value = a.capacity;
  document.getElementById('listing-notes').value = a.notes;
  document.getElementById('listing-status').value = a.status;
  document.getElementById('listing-photo').value = a.photo || '';
}

function deleteListing(id){
  if(!confirm('Delete this listing?')) return;
  const idx = state.apartments.findIndex(a=>a.id===id); if(idx>=0){
    state.activity.push(makeActivity('Deleted listing: '+state.apartments[idx].unit));
    state.apartments.splice(idx,1);
    // unassign tenants who were in that unit
    state.tenants.forEach(t=>{ if(t.unit === state.apartments[idx]?.unit) t.unit = ''; });
    saveState(); renderActiveView();
  }
}

/* ---------- Tenant CRUD ---------- */
function saveTenant(){
  const id = document.getElementById('tenant-form').dataset.editId;
  const name = document.getElementById('tenant-name').value.trim();
  const phone = document.getElementById('tenant-phone').value.trim();
  const unit = document.getElementById('tenant-unit').value;
  const rent = Number(document.getElementById('tenant-rent').value) || 0;
  const start = document.getElementById('tenant-start').value || null;
  const end = document.getElementById('tenant-end').value || null;
  const contract = document.getElementById('tenant-contract').value || '';

  if(!name){ alert('Tenant name required'); return; }
  if(id){
    const t = state.tenants.find(x=>x.id===id);
    if(t){ Object.assign(t,{name,phone,unit,rent,start,end,contract}); state.activity.push(makeActivity('Updated tenant: '+name)); }
  } else {
    state.tenants.push(createTenant(name,phone,unit,rent,start,end,contract));
    state.activity.push(makeActivity('Added tenant: '+name));
    if(unit){
      const apt = state.apartments.find(a=>a.unit===unit); if(apt) apt.status='occupied';
    }
  }
  saveState(); closeModal('addTenant'); renderActiveView();
}

function viewTenant(id){
  const t = state.tenants.find(x=>x.id===id); if(!t) return alert(JSON.stringify(t,null,2));
}

function deleteTenant(id){
  if(!confirm('Remove tenant?')) return;
  const idx = state.tenants.findIndex(x=>x.id===id);
  if(idx>=0){
    const name = state.tenants[idx].name;
    const unit = state.tenants[idx].unit;
    state.tenants.splice(idx,1);
    if(unit){
      const apt = state.apartments.find(a=>a.unit===unit); if(apt) apt.status='available';
    }
    state.activity.push(makeActivity('Removed tenant: '+name));
    saveState(); renderActiveView();
  }
}

/* ---------- Booking / Rent ---------- */
function bookUnit(aptId){
  const a = state.apartments.find(x=>x.id===aptId); if(!a) return;
  // quick booking flow: open tenant modal and prefill unit + rent
  openModal('addTenant');
  populateUnitOptions('tenant-unit');
  document.getElementById('tenant-unit').value = a.unit;
  document.getElementById('tenant-rent').value = a.price;
  document.getElementById('tenant-start').value = (new Date()).toISOString().slice(0,10);
  const end = new Date(); end.setMonth(end.getMonth()+11); // 1 year
  document.getElementById('tenant-end').value = end.toISOString().slice(0,10);
}

/* ---------- Maintenance ---------- */
function saveMaintenance(){
  const unit = document.getElementById('maint-unit').value;
  const details = document.getElementById('maint-details').value.trim();
  if(!details){ alert('Please describe the issue'); return; }
  state.maintenance.push(createMaint(unit,details,'open'));
  state.activity.push(makeActivity('Maintenance ticket created: '+unit));
  saveState(); closeModal('addMaintenance'); renderActiveView();
}
function resolveTicket(id){
  const t = state.maintenance.find(x=>x.id===id); if(!t) return;
  t.status = 'resolved';
  state.activity.push(makeActivity('Resolved ticket: '+t.unit));
  saveState(); renderActiveView();
}
function deleteMaintenance(id){
  if(!confirm('Delete ticket?')) return;
  const idx = state.maintenance.findIndex(x=>x.id===id); if(idx>=0){
    state.activity.push(makeActivity('Deleted ticket for '+state.maintenance[idx].unit));
    state.maintenance.splice(idx,1);
    saveState(); renderActiveView();
  }
}

/* ---------- Utilities ---------- */
function populateUnitOptions(selectId){
  const s = document.getElementById(selectId); if(!s) return;
  s.innerHTML = '<option value="">-- none --</option>';
  state.apartments.forEach(a => {
    const opt = document.createElement('option'); opt.value = a.unit; opt.textContent = a.unit + ' — ₱ '+ formatNum(a.price);
    s.appendChild(opt);
  });
}

function editTenant(id){
  const t = state.tenants.find(x=>x.id===id); if(!t) return;
  openModal('addTenant');
  populateUnitOptions('tenant-unit');
  document.getElementById('tenant-form').dataset.editId = id;
  document.getElementById('tenant-name').value = t.name;
  document.getElementById('tenant-phone').value = t.phone;
  document.getElementById('tenant-unit').value = t.unit;
  document.getElementById('tenant-rent').value = t.rent;
  document.getElementById('tenant-start').value = t.start;
  document.getElementById('tenant-end').value = t.end;
  document.getElementById('tenant-contract').value = t.contract;
}

function formatNum(n){ return (Number(n)||0).toLocaleString('en-PH'); }
function daysBetween(a,b){ return Math.ceil((b - a) / (1000*60*60*24)); }

/* ---------- Authentication (demo) ---------- */
function doLogin(){
  const email = document.getElementById('login-email').value.trim();
  const pass = document.getElementById('login-pass').value.trim();
  const u = demoUsers.find(x=>x.email===email && x.pass===pass);
  if(!u){ alert('Invalid demo credentials. Try owner@example.com / demo'); return; }
  state.currentUser = {role:u.role,email:u.email,name:u.name};
  state.activity.push(makeActivity(`Signed in as ${u.email}`));
  saveState(); closeModal('login'); refreshUI();
}

/* ---------- Notifications & Reminders ---------- */
function checkReminders(){
  const today = new Date();
  state.notifications = [];
  state.tenants.forEach(t=>{
    if(!t.end) return;
    const end = new Date(t.end);
    const days = daysBetween(today,end);
    if(days <= 7 && days >= 0){
      state.notifications.push({type:'lease',text:`Lease for ${t.name} (${t.unit}) ends in ${days} day(s).`,when:new Date().toISOString()});
      state.activity.push(makeActivity(`Reminder: lease ending soon for ${t.name} (${t.unit})`));
    }
    // check missed payments? (demo) — here we could add more logic
  });
  saveState();
}

function simulateReminder(){
  checkReminders();
  alert('Reminders processed. Notifications: ' + state.notifications.length);
  refreshUI();
}

/* ---------- Misc ---------- */
function updateSyntheticCounts(){
  // ensure apartment status reflect tenants
  state.apartments.forEach(a=>{
    const occ = state.tenants.some(t=>t.unit===a.unit);
    a.status = occ ? 'occupied' : a.status === 'occupied' ? 'available' : a.status;
    if(!occ && a.status==='occupied') a.status='available';
  });
}

function resetDemo(){
  if(!confirm('Reset demo data? This will clear additions.')) return;
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}
function downloadData(){
  const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'apm-demo-data.json'; a.click();
  URL.revokeObjectURL(url);
}

/* ---------- small flows ---------- */
function viewTenantDetails(tid){ alert(JSON.stringify(state.tenants.find(t=>t.id===tid),null,2)) }

/* ---------- initial actions ---------- */
window.addEventListener('load',()=>{
  loadState();
  // auto run reminders once on load
  checkReminders();
  renderActiveView();
  // attach modal close by clicking overlay
  document.querySelectorAll('.modal').forEach(m=>{
    m.addEventListener('click', (e)=>{
      if(e.target === m) m.classList.remove('open');
    });
  });
});
</script>
</body>
</html>
