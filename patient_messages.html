<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Patient Messages - Doctor Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* RESET & BODY LOCK */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html, body {
      height: 100%; /* Important: Lock screen height */
      overflow: hidden; /* Prevent entire page scrolling */
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
      color: #2d3748;
    }

    /* FLEX LAYOUT FOR BODY */
    body {
      display: flex;
    }

    /* SIDEBAR (Fixed Width) */
    .sidebar {
      background: #3d5a80;
      color: white;
      width: 260px;
      height: 100%; /* Full height */
      display: flex;
      flex-direction: column;
      z-index: 1200;
      transition: transform 0.3s ease;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      flex-shrink: 0; /* Prevent shrinking */
    }
    .sidebar.hide { transform: translateX(-260px); }
    .sidebar .logo { font-weight: 800; font-size: 1.6rem; padding: 30px 25px 20px 25px; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar .logo span { color: #98c1d9; }
    .sidebar nav { flex: 1; padding: 20px 0; overflow-y: auto; }
    .sidebar nav a { display: flex; align-items: center; gap: 12px; padding: 14px 25px; text-decoration: none; color: rgba(255,255,255,0.8); font-size: 0.95rem; border-left: 3px solid transparent; transition: all 0.2s ease; }
    .sidebar nav a i { width: 20px; text-align: center; font-size: 1.1rem; }
    .sidebar nav a:hover, .sidebar nav a.active { background: rgba(255,255,255,0.1); border-left-color: #98c1d9; color: white; }
    .sidebar .logout { padding: 20px 25px; border-top: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 10px; color: rgba(255,255,255,0.9); }
    .sidebar .logout:hover { background: rgba(0,0,0,0.2); color: #ff6b6b; }

    /* HAMBURGER */
    .hamburger { width: 30px; height: 24px; position: fixed; top: 20px; left: 20px; cursor: pointer; z-index: 1300; display: none; flex-direction: column; justify-content: space-between; }
    .hamburger div { background: #3d5a80; border-radius: 2px; height: 3px; transition: all 0.3s ease; width: 100%; }

    /* MAIN CONTENT (Flex Column) */
    .main-content {
      flex: 1; /* Take remaining width */
      height: 100%; /* Full height */
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden; /* Stop page overflow here too */
      transition: margin-left 0.3s ease;
    }

    /* TOP BAR (Fixed Height) */
    .top-bar {
      background: white;
      padding: 15px 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0; /* Don't shrink */
      z-index: 100;
    }
    .top-bar h1 { font-size: 1.6rem; color: #3d5a80; font-weight: 600; }
    .user-info { display: flex; align-items: center; gap: 12px; font-size: 1rem; color: #4a5568; }
    .user-info i { font-size: 1.8rem; color: #3d5a80; }

    /* CONTENT AREA (Flex Container) */
    .content-area {
      flex: 1; /* Take all remaining vertical space */
      display: flex;
      flex-direction: column;
      padding: 20px 30px;
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      overflow: hidden; /* CRITICAL: Prevents expansion */
      min-height: 0; /* CRITICAL: Allows flex child to shrink/scroll */
    }

    .back-button { 
      display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: white; color: #3d5a80; 
      text-decoration: none; border-radius: 8px; font-size: 0.95rem; font-weight: 500; margin-bottom: 15px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s ease; width: fit-content; flex-shrink: 0; 
    }
    .back-button:hover { background: #3d5a80; color: white; transform: translateX(-3px); }

    /* MESSAGING CONTAINER (Grid that fits available space) */
    .messaging-container {
      flex: 1; /* Grow to fill content area */
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
      min-height: 0; /* CRITICAL: Prevents grid from expanding endlessly */
      overflow: hidden;
    }

    /* CONVERSATIONS LIST (Left Panel) */
    .conversations-panel {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      height: 100%; /* Fill grid cell */
      overflow: hidden;
    }
    .conversations-header { padding: 15px 20px; border-bottom: 2px solid #e2e8f0; flex-shrink: 0; }
    .conversations-header h3 { font-size: 1.1rem; color: #2d3748; margin-bottom: 10px; }
    .search-box { position: relative; }
    .search-box input { width: 100%; padding: 8px 15px 8px 35px; border: 1px solid #cbd5e0; border-radius: 8px; font-size: 0.9rem; }
    .search-box input:focus { outline: none; border-color: #3d5a80; }
    .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #718096; font-size: 0.9rem; }

    .conversations-list { flex: 1; overflow-y: auto; }
    .conversation-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.2s ease; display: flex; gap: 12px; align-items: flex-start; }
    .conversation-item:hover { background: #f7fafc; }
    .conversation-item.active { background: #e6f2ff; border-left: 3px solid #3d5a80; }
    .conversation-item.unread { background: #f0f9ff; }
    .conversation-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, #3d5a80, #293a52); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; flex-shrink: 0; position: relative; }
    .unread-badge { position: absolute; top: -2px; right: -2px; width: 16px; height: 16px; background: #ef4444; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; border: 2px solid white; }
    .conversation-info { flex: 1; min-width: 0; }
    .conversation-info h4 { font-size: 0.9rem; color: #2d3748; margin-bottom: 2px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    .conversation-time { font-size: 0.7rem; color: #718096; }
    .conversation-preview { font-size: 0.8rem; color: #718096; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conversation-item.unread .conversation-preview { font-weight: 600; color: #2d3748; }

    /* CHAT PANEL (Right Panel - The problem area fixed) */
    .chat-panel {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      height: 100%; /* Fill grid cell */
      overflow: hidden; /* Ensure nothing spills out */
      min-height: 0; /* CRITICAL FIX */
    }

    .chat-header { padding: 15px 20px; border-bottom: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .chat-patient-info { display: flex; align-items: center; gap: 12px; }
    .chat-patient-avatar { width: 42px; height: 42px; background: linear-gradient(135deg, #3d5a80, #293a52); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; }
    .chat-patient-details h3 { font-size: 1rem; color: #2d3748; margin-bottom: 2px; }
    .chat-patient-details p { font-size: 0.8rem; color: #718096; }
    
    .patient-details { background: #f8fafc; padding: 10px 15px; border-bottom: 1px solid #e2e8f0; flex-shrink: 0; border-left: 4px solid #3d5a80; }
    .patient-details h4 { color: #2d3748; font-size: 0.85rem; margin-bottom: 5px; font-weight: 600; }
    .detail-row { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 0.8rem; }
    .detail-label { color: #4a5568; font-weight: 500; }
    .detail-value { color: #2d3748; font-weight: 600; }
    .allergy-alert { color: #dc2626; }

    /* MESSAGES AREA - SCROLLING HAPPENS HERE */
    .chat-messages {
      flex: 1; /* Take all remaining height */
      overflow-y: auto; /* Scroll ONLY inside here */
      padding: 20px;
      background: #f7fafc;
      display: flex;
      flex-direction: column;
      min-height: 0; /* CRITICAL FIX */
    }

    .message { margin-bottom: 15px; display: flex; gap: 10px; max-width: 100%; }
    .message.sent { flex-direction: row-reverse; }
    .message-avatar { width: 32px; height: 32px; background: linear-gradient(135deg, #3d5a80, #293a52); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; flex-shrink: 0; }
    .message.sent .message-avatar { background: linear-gradient(135deg, #10b981, #059669); }
    .message-content { max-width: 70%; display: flex; flex-direction: column; }
    .message.sent .message-content { align-items: flex-end; }
    .message-bubble { background: white; padding: 10px 14px; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word; font-size: 0.9rem; line-height: 1.4; }
    .message.sent .message-bubble { background: #3d5a80; color: white; border-bottom-right-radius: 2px; }
    .message:not(.sent) .message-bubble { border-bottom-left-radius: 2px; }
    .message-time { font-size: 0.7rem; color: #718096; margin-top: 4px; }
    .message.sent .message-time { color: #718096; text-align: right; }
    .message-image { max-width: 200px; max-height: 200px; border-radius: 8px; margin-top: 5px; cursor: pointer; object-fit: cover; border: 1px solid #e2e8f0; }

    /* INPUT AREA */
    .chat-input-container { padding: 15px 20px; border-top: 1px solid #e2e8f0; background: white; flex-shrink: 0; }
    .chat-input-wrapper { display: flex; gap: 10px; align-items: flex-end; }
    .chat-input { flex: 1; padding: 10px 15px; border: 1px solid #cbd5e0; border-radius: 20px; font-size: 0.9rem; resize: none; font-family: 'Segoe UI', Arial, sans-serif; max-height: 100px; overflow-y: auto; background: #f8fafc; }
    .chat-input:focus { outline: none; border-color: #3d5a80; background: white; }
    .btn-send { width: 40px; height: 40px; background: #3d5a80; color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: all 0.2s ease; flex-shrink: 0; }
    .btn-send:hover:not(:disabled) { background: #2d4560; transform: scale(1.05); }
    .btn-send:disabled { background: #cbd5e0; cursor: not-allowed; transform: none; }

    /* Empty State */
    .empty-chat { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #a0aec0; }
    .empty-chat i { font-size: 3rem; margin-bottom: 15px; opacity: 0.5; }
    .empty-chat h3 { font-size: 1.2rem; color: #4a5568; margin-bottom: 8px; }

    /* Loading */
    .loading { display: flex; align-items: center; justify-content: center; height: 100%; color: #718096; font-size: 0.9rem; }
    .spinner { border: 2px solid #e2e8f0; border-top: 2px solid #3d5a80; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin-right: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Responsive Design */
    @media (max-width: 900px) {
      .hamburger { display: flex; }
      .sidebar { position: fixed; transform: translateX(-260px); z-index: 1300; }
      .sidebar.show { transform: translateX(0); }
      .main-content { margin-left: 0; }
      .content-area { padding: 10px; }
      .messaging-container { grid-template-columns: 1fr; }
      /* Toggle visibility based on state (JS handled usually, but CSS helps) */
      .conversations-panel { display: flex; } 
      .chat-panel { display: none; } /* Default state on mobile, JS toggles this */
      
      /* Only applied if a conversation is active on mobile */
      .messaging-container.active-chat .conversations-panel { display: none; }
      .messaging-container.active-chat .chat-panel { display: flex; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="logo">MEDI<span>Care</span></div>
    <nav>
      <a href="doctor_dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
      <a href="doctor_profile.html"><i class="fas fa-user"></i> Profile</a>
      <a href="doctor_patients.html" class="active"><i class="fas fa-users"></i> Patients</a>
      <a href="#"><i class="fas fa-heartbeat"></i> Symptom Analysis</a>
      <a href="#"><i class="fas fa-video"></i> Teleconsultation</a>
      <a href="#"><i class="fas fa-bell"></i> Notifications</a>
    </nav>
    <div class="logout" onclick="location.href='doctor_logout.php'">
      <i class="fas fa-sign-out-alt"></i> Logout
    </div>
  </div>

  <!-- Hamburger Menu -->
  <div class="hamburger" id="hamburger">
    <div></div><div></div><div></div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="top-bar">
      <h1>Patient Messages</h1>
      <div class="user-info">
        <i class="fas fa-user-circle"></i>
        <span>Dr. <span class="user-name" id="username">John Doe</span></span>
      </div>
    </div>

    <div class="content-area">
      <!-- Back button logic to return to list on mobile -->
      <a href="doctor_patients.html" class="back-button" id="backBtn" onclick="handleBack(event)">
        <i class="fas fa-arrow-left"></i> Back
      </a>

      <!-- Messaging Container -->
      <div class="messaging-container" id="msgContainer">
        
        <!-- Conversations List -->
        <div class="conversations-panel">
          <div class="conversations-header">
            <h3>Messages</h3>
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input type="text" id="searchConversations" placeholder="Search...">
            </div>
          </div>
          <div class="conversations-list" id="conversationsList">
            <div class="loading">
              <div class="spinner"></div>Loading...
            </div>
          </div>
        </div>

        <!-- Chat Panel -->
        <div class="chat-panel">
          <div id="chatContent" class="empty-chat">
            <i class="fas fa-comments"></i>
            <h3>Select a Conversation</h3>
            <p>Choose a patient to view messages</p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const sidebar = document.getElementById('sidebar');
    const hamburger = document.getElementById('hamburger');
    const msgContainer = document.getElementById('msgContainer');
    
    hamburger.addEventListener('click', function() {
      sidebar.classList.toggle('show');
    });

    // Mobile Back Handler
    function handleBack(e) {
      // If on mobile and inside a chat, go back to list
      if (window.innerWidth <= 900 && msgContainer.classList.contains('active-chat')) {
        e.preventDefault();
        msgContainer.classList.remove('active-chat');
        currentConversation = null;
        // Stop polling when going back to list
        if (pollInterval) clearInterval(pollInterval);
      }
      // Otherwise allow default link behavior (go to doctor_patients.html)
    }

    let conversations = [];
    let currentConversation = null;
    let lastMessageId = 0;
    let pollInterval = null;
    const DOCTOR_ID = sessionStorage.getItem('doctor_id') || 'DOC001';

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    async function loadConversations() {
      try {
        const response = await fetch(`get_doctor_conversations.php?doctor_id=${DOCTOR_ID}`);
        const data = await response.json();
        if (data.success) {
          conversations = data.conversations;
          displayConversations();
        }
      } catch (error) { console.error(error); }
    }

    function displayConversations() {
      const container = document.getElementById('conversationsList');
      const searchTerm = document.getElementById('searchConversations').value.toLowerCase();
      const filtered = conversations.filter(c => c.patient_name.toLowerCase().includes(searchTerm));

      if (filtered.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #a0aec0; font-size: 0.9rem;">No conversations found</div>';
        return;
      }

      container.innerHTML = '';
      filtered.forEach(conv => {
        const initials = conv.patient_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const isActive = currentConversation && currentConversation.consultation_id === conv.consultation_id;
        
        const item = document.createElement('div');
        item.className = `conversation-item ${conv.unread_count > 0 ? 'unread' : ''} ${isActive ? 'active' : ''}`;
        item.onclick = () => openConversation(conv.consultation_id);
        
        item.innerHTML = `
          <div class="conversation-avatar">
            ${initials}
            ${conv.unread_count > 0 ? `<span class="unread-badge">${conv.unread_count}</span>` : ''}
          </div>
          <div class="conversation-info">
            <h4>${escapeHtml(conv.patient_name)} <span class="conversation-time">${formatTime(conv.last_message_time)}</span></h4>
            <p class="conversation-preview">${escapeHtml(conv.last_message) || 'Start conversation'}</p>
          </div>
        `;
        container.appendChild(item);
      });
    }

    async function openConversation(consultationId) {
      const conv = conversations.find(c => c.consultation_id === consultationId);
      if (!conv) return;

      currentConversation = conv;
      lastMessageId = 0;

      // Mark as read
      fetch('mark_messages_read.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ consultation_id: consultationId, doctor_id: DOCTOR_ID })
      });

      // UI Updates
      document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
      displayConversations(); 
      
      // Mobile support
      msgContainer.classList.add('active-chat');

      setupChatUI(conv);
      await loadMessages(consultationId);

      if (pollInterval) clearInterval(pollInterval);
      pollInterval = setInterval(() => pollMessages(consultationId), 3000);
    }

    function setupChatUI(conv) {
      const initials = conv.patient_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
      const chatContent = document.getElementById('chatContent');
      chatContent.className = ''; 
      
      chatContent.innerHTML = `
        <div class="chat-header">
          <div class="chat-patient-info">
            <div class="chat-patient-avatar">${initials}</div>
            <div class="chat-patient-details">
              <h3>${escapeHtml(conv.patient_name)}</h3>
              <p>ID: ${escapeHtml(conv.patient_id)}</p>
            </div>
          </div>
        </div>
        
        <div class="patient-details">
          <div class="detail-row">
             <span class="detail-label">Complaint:</span>
             <span class="detail-value">${escapeHtml(conv.chief_complaint || 'N/A')}</span>
          </div>
          <div class="detail-row">
             <span class="detail-label">Allergies:</span>
             <span class="detail-value ${conv.allergies ? 'allergy-alert' : ''}">${escapeHtml(conv.allergies || 'None')}</span>
          </div>
        </div>

        <div class="chat-messages" id="chatMessages">
           <div class="loading"><div class="spinner"></div>Loading messages...</div>
        </div>

        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <textarea class="chat-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
            <button class="btn-send" id="sendBtn" onclick="sendMessage()">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      `;

      // Auto-resize textarea
      const textarea = document.getElementById('messageInput');
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
      });
      textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    async function loadMessages(consultationId) {
      const container = document.getElementById('chatMessages');
      try {
        const res = await fetch(`get_messages.php?consultation_id=${consultationId}`);
        const data = await res.json();
        
        if (data.success) {
          container.innerHTML = '';
          if (data.messages.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#ccc;margin-top:auto;margin-bottom:auto;">No messages yet.</div>';
          } else {
            data.messages.forEach(msg => {
              appendMessage(msg);
              lastMessageId = Math.max(lastMessageId, msg.id || 0);
            });
            scrollToBottom();
          }
        }
      } catch (e) {
        container.innerHTML = '<div style="color:red;text-align:center">Error loading messages</div>';
      }
    }

    async function pollMessages(consultationId) {
      if (!currentConversation || currentConversation.consultation_id !== consultationId) return;
      try {
        const res = await fetch(`get_messages.php?consultation_id=${consultationId}&since=${lastMessageId}`);
        const data = await res.json();
        if (data.success && data.messages.length > 0) {
          data.messages.forEach(msg => {
            if (!document.getElementById(`msg-${msg.id}`)) {
               appendMessage(msg);
               lastMessageId = Math.max(lastMessageId, msg.id);
            }
          });
          scrollToBottom();
        }
      } catch (e) { console.error(e); }
    }

    function appendMessage(msg) {
      const container = document.getElementById('chatMessages');
      const isMe = msg.sender === 'doctor';
      const initials = currentConversation.patient_name.charAt(0).toUpperCase();

      let attachmentHtml = '';
      if (msg.attachment && msg.attachment.file_path) {
        const file = msg.attachment;
        if (file.file_type && file.file_type.startsWith('image/')) {
           attachmentHtml = `<img src="${file.file_path}" class="message-image" onclick="window.open('${file.file_path}', '_blank')">`;
        } else {
           attachmentHtml = `<a href="${file.file_path}" target="_blank" style="display:block;margin-top:5px;font-size:0.85rem;color:#2b6cb0;text-decoration:underline;">
             <i class="fas fa-paperclip"></i> ${escapeHtml(file.file_name || 'Attachment')}
           </a>`;
        }
      }

      const div = document.createElement('div');
      div.className = `message ${isMe ? 'sent' : ''}`;
      div.id = `msg-${msg.id}`;
      div.innerHTML = `
        <div class="message-avatar">${isMe ? 'D' : initials}</div>
        <div class="message-content">
          <div class="message-bubble">
            <div class="message-text">${escapeHtml(msg.message)}</div>
            ${attachmentHtml}
          </div>
          <div class="message-time">${formatTime(msg.timestamp)}</div>
        </div>
      `;
      container.appendChild(div);
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      const btn = document.getElementById('sendBtn');
      
      if (!text || !currentConversation) return;

      btn.disabled = true;
      try {
        const res = await fetch('send_message.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
             consultation_id: currentConversation.consultation_id,
             doctor_id: DOCTOR_ID,
             patient_id: currentConversation.patient_id,
             message: text
          })
        });
        const data = await res.json();
        if (data.success) {
           input.value = '';
           input.style.height = 'auto';
           pollMessages(currentConversation.consultation_id);
        } else {
           alert('Failed to send: ' + data.message);
        }
      } catch (e) { alert('Connection error'); } 
      finally { btn.disabled = false; }
    }

    function scrollToBottom() {
      const container = document.getElementById('chatMessages');
      if (container) container.scrollTop = container.scrollHeight;
    }

    function formatTime(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const now = new Date();
      if (date.toDateString() === now.toDateString()) {
         return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
      return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    }

    document.getElementById('searchConversations').addEventListener('input', displayConversations);
    document.addEventListener('DOMContentLoaded', () => {
      loadConversations();
      setInterval(loadConversations, 10000);
    });
  </script>
</body>
</html>
