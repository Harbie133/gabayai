<!DOCTYPE html>
<html lang="en">
    

<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GabayAI - Patient Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* === PURPLE THEME DESIGN (Patient Side) === */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Purple Gradient */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Animated Bubbles */
        .bubbles-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .bubble { position: absolute; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); backdrop-filter: blur(2px); animation: floatUp linear infinite; opacity: 0; }
        .bubble:nth-child(1) { left: 10%; width: 80px; height: 80px; animation-duration: 15s; }
        .bubble:nth-child(2) { left: 20%; width: 40px; height: 40px; animation-duration: 12s; animation-delay: 2s; }
        .bubble:nth-child(3) { left: 70%; width: 120px; height: 120px; animation-duration: 20s; animation-delay: 3s; }
        @keyframes floatUp { 0% { transform: translateY(100vh) rotate(0deg); opacity: 0; } 10% { opacity: 0.6; } 100% { transform: translateY(-100px) rotate(360deg); opacity: 0; } }

        /* Main Card */
        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            width: 100%; max-width: 450px;
            position: relative; z-index: 1;
            animation: slideUp 0.6s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .auth-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; text-align: center; padding: 30px;
        }
        .auth-header h1 { font-size: 2rem; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .auth-header p { opacity: 0.9; font-size: 0.95rem; }

        .tab-nav { display: flex; background: #f8f9fa; border-bottom: 1px solid #e1e4e8; }
        .tab-button {
            flex: 1; padding: 15px; background: none; border: none; cursor: pointer;
            font-size: 1rem; font-weight: 600; color: #718096; transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active { color: #764ba2; border-bottom-color: #764ba2; background: white; border-radius: 8px 8px 0 0; }
        .tab-button:hover:not(.active) { color: #2d3748; background: rgba(0,0,0,0.02); }

        .form-container { padding: 30px; background: white; }
        .form-tab { display: none; animation: fadeIn 0.3s ease-in; }
        .form-tab.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; color: #4a5568; font-weight: 600; font-size: 0.9rem; }
        .form-group input {
            width: 100%; padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 8px;
            font-size: 1rem; outline: none; transition: all 0.3s ease;
        }
        .form-group input:focus { border-color: #764ba2; box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1); }
        
        .password-group { position: relative; }
        .password-toggle {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            background: none; border: none; color: #718096; cursor: pointer; font-size: 1.1rem;
        }
        .password-toggle:hover { color: #764ba2; }

        /* Captcha Style */
        .captcha-container { background: #f3f0ff; border: 1px solid #e9d8fd; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .captcha-display { display: flex; gap: 10px; margin-bottom: 10px; }
        .captcha-code {
            flex: 1; background: white; border: 2px dashed #b794f4; padding: 10px;
            border-radius: 6px; font-family: monospace; font-size: 1.3rem; font-weight: bold;
            color: #553c9a; text-align: center; letter-spacing: 5px; user-select: none;
        }
        .captcha-refresh {
            width: 45px; background: #764ba2; color: white; border: none; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .captcha-refresh:hover { background: #553c9a; transform: rotate(180deg); }

        .forgot-link { display: inline-block; margin-bottom: 20px; color: #764ba2; text-decoration: none; font-size: 0.9rem; font-weight: 500; cursor: pointer; }
        .forgot-link:hover { text-decoration: underline; }

        .auth-btn {
            width: 100%; padding: 14px; background: #764ba2; color: white; border: none;
            border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
        }
        .auth-btn:hover { background: #553c9a; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(118, 75, 162, 0.3); }

        .error-message { color: #e53e3e; font-size: 0.85rem; margin-top: 5px; display: none; }
        .loading { display: none; text-align: center; margin-top: 15px; color: #764ba2; font-weight: 600; }

        /* === MODALS (Forgot Password & Success) === */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        
        .modal-content { background: white; padding: 0; border-radius: 15px; width: 90%; max-width: 400px; animation: slideDown 0.3s; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { background: #764ba2; padding: 20px; color: white; display: flex; justify-content: space-between; align-items: center; }
        
        /* New Style for Success Header (Green) */
        .modal-header.centered { justify-content: center; background: #38a169; }
        
        .modal-body { padding: 30px; text-align: center; }
        .modal-body p { margin-bottom: 20px; color: #4a5568; font-size: 1.1rem; }
        
        .close-modal { cursor: pointer; font-size: 1.5rem; transition: 0.2s; }
        .close-modal:hover { transform: rotate(90deg); }
        @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div class="bubbles-container">
        <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
        <div class="bubble"></div><div class="bubble"></div>
    </div>

    <div class="auth-container">
        <div class="auth-header">
            <h1><i class="fas fa-heartbeat"></i> GabayAI</h1>
            <p>Patient Portal Access</p>
        </div>

        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab('login')"><i class="fas fa-sign-in-alt"></i> Login</button>
            <button class="tab-button" onclick="switchTab('register')"><i class="fas fa-user-plus"></i> Register</button>
        </div>

        <div class="form-container">
            <!-- LOGIN TAB -->
            <div id="loginTab" class="form-tab active">
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="loginUser" required placeholder="Enter username">
                    </div>

                    <div class="form-group">
                        <label>Password</label>
                        <div class="password-group">
                            <input type="password" id="loginPass" required placeholder="Enter password">
                            <button type="button" class="password-toggle" onclick="togglePass('loginPass', this)"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>

                    <div class="captcha-container">
                        <div class="captcha-display">
                            <div class="captcha-code" id="loginCaptchaText"></div>
                            <button type="button" class="captcha-refresh" onclick="genCaptcha('login')"><i class="fas fa-sync"></i></button>
                        </div>
                        <input type="text" id="loginCaptchaInput" placeholder="Type the code above" required>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:20px;">
                            <input type="checkbox"> <label style="margin:0; font-weight:normal;">Remember me</label>
                        </div>
                        <a class="forgot-link" onclick="openModal()">Forgot password?</a>
                    </div>

                    <button type="submit" class="auth-btn" id="loginBtn">Sign In</button>
                    <div class="loading" id="loginLoad">Logging in...</div>
                </form>
            </div>

            <!-- REGISTER TAB -->
            <div id="registerTab" class="form-tab">
                <form onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="regUser" required minlength="3" placeholder="Choose a username">
                    </div>

                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="regEmail" required placeholder="Enter active email">
                    </div>

                    <div class="form-group">
                        <label>Password</label>
                        <div class="password-group">
                            <input type="password" id="regPass" required minlength="6" placeholder="Create password">
                            <button type="button" class="password-toggle" onclick="togglePass('regPass', this)"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Confirm Password</label>
                        <div class="password-group">
                            <input type="password" id="regConfirm" required placeholder="Repeat password">
                            <button type="button" class="password-toggle" onclick="togglePass('regConfirm', this)"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>

                    <div class="captcha-container">
                        <div class="captcha-display">
                            <div class="captcha-code" id="regCaptchaText"></div>
                            <button type="button" class="captcha-refresh" onclick="genCaptcha('reg')"><i class="fas fa-sync"></i></button>
                        </div>
                        <input type="text" id="regCaptchaInput" placeholder="Type the code above" required>
                    </div>

                    <button type="submit" class="auth-btn" id="regBtn">Create Account</button>
                    <div class="loading" id="regLoad">Creating account...</div>
                </form>
            </div>
        </div>
    </div>

    <!-- FORGOT MODAL -->
    <div id="forgotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reset Password</h3>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" style="text-align: left;">
                <form onsubmit="handleForgot(event)">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="forgotEmail" required placeholder="Enter registered email">
                    </div>

                    <div class="captcha-container">
                        <div class="captcha-display">
                            <div class="captcha-code" id="forgotCaptchaText"></div>
                            <button type="button" class="captcha-refresh" onclick="genCaptcha('forgot')"><i class="fas fa-sync"></i></button>
                        </div>
                        <input type="text" id="forgotCaptchaInput" placeholder="Type the code above" required>
                        <div class="error-message" id="forgotCaptchaError" style="display:none; color:red; margin-top:5px;">Incorrect Code</div>
                    </div>

                    <button type="submit" class="auth-btn" id="forgotBtn">Send Reset Link</button>
                    <div class="loading" id="forgotLoad">Sending email...</div>
                </form>
            </div>
        </div>
    </div>

    <!-- SUCCESS MODAL (New!) -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="modal-header centered">
                <h3><i class="fas fa-check-circle"></i> Success</h3>
            </div>
            <div class="modal-body">
                <p id="successMessageText">Account created successfully!</p>
                <button class="auth-btn" onclick="closeSuccessModal()">Go to Login</button>
            </div>
        </div>
    </div>

    <script>
                // GabayAI Supabase (from Vercel env vars)
        const SUPABASE_URL = 'https://fuicwbgwylpcwsncbrup.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1aWN3Ymd3eWxwY3dzbmNicnVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MjQyMTIsImV4cCI6MjA4MzAwMDIxMn0.pAA0qOd68BqIfqRldWMUuK1s_DAwjp9n34BAPydMdhk';  // From API page
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const captchas = { login: '', reg: '', forgot: '' };

        function genCaptcha(type) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let res = '';
            for(let i=0; i<6; i++) res += chars.charAt(Math.floor(Math.random()*chars.length));
            captchas[type] = res;
            
            if(type==='login') {
                document.getElementById('loginCaptchaText').innerText = res;
                document.getElementById('loginCaptchaInput').value = '';
            } else if(type==='reg') {
                document.getElementById('regCaptchaText').innerText = res;
                document.getElementById('regCaptchaInput').value = '';
            } else {
                document.getElementById('forgotCaptchaText').innerText = res;
                document.getElementById('forgotCaptchaInput').value = '';
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.form-tab').forEach(f => f.classList.remove('active'));
            
            if(tab === 'login') {
                document.querySelectorAll('.tab-button')[0].classList.add('active');
                document.getElementById('loginTab').classList.add('active');
                genCaptcha('login');
            } else {
                document.querySelectorAll('.tab-button')[1].classList.add('active');
                document.getElementById('registerTab').classList.add('active');
                genCaptcha('reg');
            }
        }

        function togglePass(id, btn) {
            let x = document.getElementById(id);
            let icon = btn.querySelector('i');
            if(x.type === 'password') { x.type = 'text'; icon.className = 'fas fa-eye-slash'; }
            else { x.type = 'password'; icon.className = 'fas fa-eye'; }
        }

        // --- SUCCESS MODAL FUNCTIONS ---
        function openSuccessModal(msg) {
            document.getElementById('successMessageText').innerText = msg;
            document.getElementById('successModal').classList.add('show');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('show');
            switchTab('login'); // Automatically switch to login tab
        }

        // --- HANDLERS (CONNECTED TO BACKEND) ---

        async function handleLogin(e) {
                e.preventDefault();
                let user = document.getElementById('loginUser').value;
                let pass = document.getElementById('loginPass').value;
                let code = document.getElementById('loginCaptchaInput').value.toUpperCase();
            
                if(code !== captchas.login.toUpperCase()) {
                    alert('Incorrect Captcha');
                    genCaptcha('login');
                    return;
                }
            
                let btn = document.getElementById('loginBtn');
                let load = document.getElementById('loginLoad');
                btn.style.display = 'none';
                load.style.display = 'block';
            
                try {
                    // SUPABASE QUERY - GabayAI users table
                    const { data, error } = await supabase
                        .from('users')
                        .select('id, username, password, is_active, first_name')
                        .eq('username', user)
                        .single();
            
                    if (error && error.code !== 'PGRST116') {  // No row found
                        throw error;
                    }
            
                    if (data && data.password === pass && data.is_active) {
                        // Save user session
                        localStorage.setItem('gabayai_user', JSON.stringify({
                            id: data.id,
                            username: data.username,
                            first_name: data.first_name || data.username
                        }));
                        window.location.href = 'homer.html';
                    } else {
                        alert('Invalid username or password');
                        genCaptcha('login');
                    }
                } catch (err) {
                    console.error('Login error:', err);
                    alert('Login failed. Check username/password.');
                } finally {
                    btn.style.display = 'block';
                    load.style.display = 'none';
                }
            }


        async function handleRegister(e) {
    e.preventDefault();
    let user = document.getElementById('regUser').value.trim();
    let email = document.getElementById('regEmail').value.trim();
    let pass = document.getElementById('regPass').value;
    let confirm = document.getElementById('regConfirm').value;
    let code = document.getElementById('regCaptchaInput').value.toUpperCase();

    // Validation
    if(pass !== confirm) { 
        alert('Passwords do not match'); 
        return; 
    }
    if(code !== captchas.reg.toUpperCase()) {
        alert('Incorrect Captcha');
        genCaptcha('reg');
        return;
    }
    if(user.length < 3) {
        alert('Username must be 3+ characters');
        return;
    }

    let btn = document.getElementById('regBtn');
    let load = document.getElementById('regLoad');
    btn.style.display = 'none';
    load.style.display = 'block';

    try {
        // Check if user/email exists
        const { data: existing } = await supabase
            .from('users')
            .select('id')
            .or(`username.eq.${user},email.eq.${email}`)
            .single();

        if (existing) {
            alert('Username or email already exists');
            genCaptcha('reg');
            return;
        }

        // SUPABASE REGISTER - GabayAI users table
        const { data, error } = await supabase
            .from('users')
            .insert({
                username: user,
                email: email,
                password: pass,  // TODO: Hash with bcrypt sa production
                first_name: user.split(' ')[0],  // Auto from username
                is_active: true,
                created_at: new Date().toISOString()
            })
            .select('id, username, email')
            .single();

        if (!error && data) {
            // Reset Form
            document.getElementById('regUser').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPass').value = '';
            document.getElementById('regConfirm').value = '';
            document.getElementById('regCaptchaInput').value = '';
            
            // Show Success Modal
            openSuccessModal('Account created successfully! Please login.');
        } else {
            alert(error?.message || 'Registration failed');
            genCaptcha('reg');
        }
    } catch (err) {
        console.error('Register error:', err);
        alert('Registration failed. Try again.');
        genCaptcha('reg');
    } finally {
        btn.style.display = 'block';
        load.style.display = 'none';
    }
}


        // --- FORGOT PASSWORD LOGIC ---
        // --- FORGOT PASSWORD LOGIC (Supabase Version) ---
function openModal() { 
    document.getElementById('forgotModal').classList.add('show'); 
    genCaptcha('forgot'); 
}
function closeModal() { document.getElementById('forgotModal').classList.remove('show'); }

async function handleForgot(e) {
    e.preventDefault();
    let email = document.getElementById('forgotEmail').value.trim();
    let code = document.getElementById('forgotCaptchaInput').value.toUpperCase();

    if(code !== captchas.forgot.toUpperCase()) {
        document.getElementById('forgotCaptchaError').style.display = 'block';
        genCaptcha('forgot');
        return;
    } else {
        document.getElementById('forgotCaptchaError').style.display = 'none';
    }

    let btn = document.getElementById('forgotBtn');
    let load = document.getElementById('forgotLoad');
    btn.style.display = 'none';
    load.style.display = 'block';

    try {
        // SUPABASE: Check if email exists sa users table
        const { data: user, error: checkError } = await supabase
            .from('users')
            .select('id, email, username')
            .eq('email', email)
            .single();

        if (checkError && checkError.code !== 'PGRST116') {
            throw checkError;
        }

        if (!user) {
            alert('Email not found');
        } else {
            // Generate 6-digit reset code (expires 1 hour)
            const resetCode = Math.floor(100000 + Math.random() * 900000).toString();
            const expiresAt = new Date(Date.now() + 60 * 60 * 1000).toISOString();  // 1 hour

            // Save to password_resets table
            const { error: insertError } = await supabase
                .from('password_resets')
                .insert({
                    user_id: user.id,
                    reset_code: resetCode,
                    expires_at: expiresAt
                });

            if (!insertError) {
                alert(`Reset code sent! Your code: ${resetCode}\n(Valid for 1 hour - check email simulation)`);
                console.log(`Demo: User ${user.username} reset code: ${resetCode} expires: ${expiresAt}`);
                closeModal();
            } else {
                alert('Failed to generate reset code');
            }
        }
    } catch (err) {
        console.error('Forgot password error:', err);
        alert('Reset failed. Try again.');
    } finally {
        btn.style.display = 'block';
        load.style.display = 'none';
    }
}

window.onload = function() { genCaptcha('login'); };
window.onclick = function(e) { 
    if(e.target === document.getElementById('forgotModal')) closeModal(); 
    if(e.target === document.getElementById('successModal')) closeSuccessModal(); 
}

    </script>
</body>
</html>
