<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Portal - GabayAI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Animated Bubbles Background */
        .bubbles-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .bubble {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(61, 90, 128, 0.2), rgba(61, 90, 128, 0.05));
            backdrop-filter: blur(2px);
            animation: floatUp linear infinite;
            opacity: 0;
        }

        .bubble:nth-child(1) { left: 10%; width: 80px; height: 80px; animation-duration: 15s; animation-delay: 0s; }
        .bubble:nth-child(2) { left: 20%; width: 40px; height: 40px; animation-duration: 12s; animation-delay: 2s; }
        .bubble:nth-child(3) { left: 35%; width: 100px; height: 100px; animation-duration: 18s; animation-delay: 4s; }
        .bubble:nth-child(4) { left: 50%; width: 60px; height: 60px; animation-duration: 14s; animation-delay: 1s; }
        .bubble:nth-child(5) { left: 70%; width: 120px; height: 120px; animation-duration: 20s; animation-delay: 3s; }
        .bubble:nth-child(6) { left: 80%; width: 30px; height: 30px; animation-duration: 10s; animation-delay: 5s; }
        .bubble:nth-child(7) { left: 15%; width: 90px; height: 90px; animation-duration: 16s; animation-delay: 6s; }
        .bubble:nth-child(8) { left: 65%; width: 50px; height: 50px; animation-duration: 13s; animation-delay: 7s; }

        @keyframes floatUp {
            0% { transform: translateY(100vh) translateX(0px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-100px) translateX(20px) rotate(360deg); opacity: 0; }
        }

        /* Main Card Container */
        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(61, 90, 128, 0.15), 0 5px 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            width: 100%;
            max-width: 480px;
            position: relative;
            z-index: 1;
            animation: slideUp 0.6s ease-out;
        }

        .auth-header {
            background: linear-gradient(135deg, #3d5a80 0%, #293a52 100%);
            color: white;
            text-align: center;
            padding: 30px;
            position: relative;
            overflow: hidden;
        }

        .auth-header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .auth-header p { opacity: 0.9; font-size: 0.95rem; }

        .tab-nav {
            display: flex;
            background: #f8f9fa;
            padding: 5px 5px 0;
            border-bottom: 1px solid #e1e4e8;
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #718096;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: #3d5a80;
            border-bottom-color: #3d5a80;
            background: white;
            border-radius: 8px 8px 0 0;
        }

        .tab-button:hover:not(.active) {
            color: #2d3748;
            background: rgba(0,0,0,0.02);
        }

        .form-container { padding: 30px; background: white; }

        .form-tab { display: none; animation: fadeIn 0.3s ease-in; }
        .form-tab.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group { margin-bottom: 18px; }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
        }

        .form-group input:focus {
            border-color: #3d5a80;
            box-shadow: 0 0 0 3px rgba(61, 90, 128, 0.1);
        }

        .form-group input.error {
            border-color: #e53e3e;
            background-color: #fff5f5;
        }

        .password-group { position: relative; }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #718096;
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.3s;
        }

        .password-toggle:hover { color: #3d5a80; }

        .password-strength {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
            display: none;
        }

        .password-strength.active { display: block; }

        .password-strength-bar {
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        .strength-weak { background: #e53e3e; width: 33%; }
        .strength-medium { background: #f59e0b; width: 66%; }
        .strength-strong { background: #10b981; width: 100%; }

        .captcha-container {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .captcha-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 0.9rem;
            color: #4a5568;
            font-weight: 600;
        }

        .captcha-display {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .captcha-code {
            flex: 1;
            background: white;
            border: 2px dashed #cbd5e0;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 1.3rem;
            font-weight: bold;
            color: #2d3748;
            letter-spacing: 5px;
            text-align: center;
            user-select: none;
        }

        .captcha-refresh {
            width: 45px;
            background: #3d5a80;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .captcha-refresh:hover {
            background: #2c425e;
            transform: rotate(180deg);
        }

        .forgot-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #3d5a80;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
        }

        .forgot-link:hover { text-decoration: underline; }

        .auth-btn {
            width: 100%;
            padding: 14px;
            background: #3d5a80;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-btn:hover {
            background: #2c425e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(61, 90, 128, 0.3);
        }

        .error-message {
            color: #e53e3e;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .success-message {
            background: #f0fff4;
            color: #276749;
            border: 1px solid #c6f6d5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 0.9rem;
            text-align: center;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 15px;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(61, 90, 128, 0.2);
            border-top: 3px solid #3d5a80;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: white;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            animation: slideDown 0.3s ease;
            overflow: hidden;
            text-align: center; /* Center content in modal */
        }

        @keyframes slideDown {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: #3d5a80;
            padding: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Specific header for success modal to center title */
        .modal-header.centered {
            justify-content: center;
            background: #276749; /* Green for success */
        }

        .modal-header h3 { margin: 0; font-size: 1.25rem; }
        .close-modal { cursor: pointer; font-size: 1.5rem; transition: transform 0.3s; }
        .close-modal:hover { transform: rotate(90deg); }

        .modal-body { padding: 30px; }
        
        .modal-btn {
            background: #3d5a80;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 1rem;
        }
        .modal-btn:hover { background: #2c425e; }
    </style>
</head>
<body>
    <div class="bubbles-container">
        <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
        <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
        <div class="bubble"></div><div class="bubble"></div>
    </div>

    <div class="auth-container">
        <div class="auth-header">
            <h1><i class="fas fa-user-md"></i> GabayAI</h1>
            <p>Doctor Portal Access</p>
        </div>

        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab(event,'login')">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            <button class="tab-button" onclick="switchTab(event,'register')">
                <i class="fas fa-user-plus"></i> Register
            </button>
        </div>

        <div class="form-container">
            <!-- LOGIN -->
            <div id="loginTab" class="form-tab active">
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="loginUsername">Username</label>
                        <input type="text" id="loginUsername" placeholder="Enter your username" required>
                        <div class="error-message" id="loginUsernameError"></div>
                    </div>

                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <div class="password-group">
                            <input type="password" id="loginPassword" placeholder="Enter your password" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="loginPasswordError"></div>
                    </div>

                    <div class="captcha-container">
                        <div class="captcha-header">
                            <i class="fas fa-shield-alt"></i> Security Verification
                        </div>
                        <div class="captcha-display">
                            <div class="captcha-code" id="loginCaptchaDisplay"></div>
                            <button type="button" class="captcha-refresh" onclick="generateCaptcha('login')">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                        <input type="text" id="loginCaptchaInput" placeholder="Type the code above" required>
                        <div class="error-message" id="loginCaptchaError"></div>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:20px;">
                            <input type="checkbox" id="rememberMe" style="width:auto;">
                            <label for="rememberMe" style="margin:0; font-weight:normal; font-size:0.9rem;">Remember me</label>
                        </div>
                        <a class="forgot-link" onclick="openForgotModal()">Forgot password?</a>
                    </div>

                    <button type="submit" class="auth-btn" id="loginBtn">Sign In</button>

                    <div class="loading" id="loginLoading">
                        <div class="spinner"></div>
                        <p>Accessing portal...</p>
                    </div>
                </form>
            </div>

            <!-- REGISTER -->
            <div id="registerTab" class="form-tab">
                <form id="registerForm" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label for="regUsername">Username</label>
                        <input type="text" id="regUsername" placeholder="Choose a username" required minlength="3">
                        <div class="error-message" id="regUsernameError"></div>
                    </div>

                    <div class="form-group">
                        <label for="regEmail">Email Address</label>
                        <input type="email" id="regEmail" placeholder="Enter your email address" required>
                        <div class="error-message" id="regEmailError"></div>
                    </div>

                    <div class="form-group">
                        <label for="regPassword">Password</label>
                        <div class="password-group">
                            <input type="password" id="regPassword" placeholder="Create a strong password" required minlength="6" oninput="checkStrength(this.value)">
                            <button type="button" class="password-toggle" onclick="togglePassword('regPassword', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="password-strength" id="strengthWrapper">
                            <div class="password-strength-bar" id="strengthBar"></div>
                        </div>
                        <div class="error-message" id="regPasswordError"></div>
                    </div>

                    <div class="form-group">
                        <label for="regConfirmPass">Confirm Password</label>
                        <div class="password-group">
                            <input type="password" id="regConfirmPass" placeholder="Repeat your password" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('regConfirmPass', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="regConfirmPassError"></div>
                    </div>

                    <div class="captcha-container">
                        <div class="captcha-header">
                            <i class="fas fa-shield-alt"></i> Security Verification
                        </div>
                        <div class="captcha-display">
                            <div class="captcha-code" id="regCaptchaDisplay"></div>
                            <button type="button" class="captcha-refresh" onclick="generateCaptcha('register')">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                        <input type="text" id="regCaptchaInput" placeholder="Type the code above" required>
                        <div class="error-message" id="regCaptchaError"></div>
                    </div>

                    <button type="submit" class="auth-btn" id="regBtn">Create Account</button>

                    <div class="loading" id="regLoading">
                        <div class="spinner"></div>
                        <p>Creating your profile...</p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- FORGOT MODAL -->
    <div id="forgotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reset Password</h3>
                <span class="close-modal" onclick="closeForgotModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="forgotForm" onsubmit="handleForgot(event)">
                    <div class="form-group">
                        <label for="forgotEmail">Email Address</label>
                        <input type="email" id="forgotEmail" placeholder="Enter your registered email" required>
                    </div>

                    <div class="captcha-container">
                        <div class="captcha-display">
                            <div class="captcha-code" id="forgotCaptchaDisplay"></div>
                            <button type="button" class="captcha-refresh" onclick="generateCaptcha('forgot')">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                        <input type="text" id="forgotCaptchaInput" placeholder="Type the code above" required>
                        <div class="error-message" id="forgotCaptchaError"></div>
                    </div>

                    <button type="submit" class="auth-btn" id="forgotBtn">Send Reset Link</button>

                    <div class="loading" id="forgotLoading">
                        <div class="spinner"></div>
                        <p>Processing...</p>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- SUCCESS MODAL (New Added) -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="modal-header centered">
                <h3><i class="fas fa-check-circle"></i> Success</h3>
            </div>
            <div class="modal-body">
                <p id="successMessageText" style="font-size: 1.1rem; color: #2d3748; margin-bottom: 20px;">
                    Account created successfully!
                </p>
                <button class="modal-btn" onclick="closeSuccessModal()">Go to Login</button>
            </div>
        </div>
    </div>

    <script>
        const captchas = { login: '', register: '', forgot: '' };
        let registeredUser = ''; // Store username to prefill

        document.addEventListener('DOMContentLoaded', () => {
            generateCaptcha('login');
            generateCaptcha('register');
            generateCaptcha('forgot');
            loadRememberedUser();
            checkSession();
        });

        function generateCaptcha(type) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 6; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            captchas[type] = result;

            const displayId = type === 'login' ? 'loginCaptchaDisplay'
                            : type === 'register' ? 'regCaptchaDisplay'
                            : 'forgotCaptchaDisplay';

            const inputId = type === 'login' ? 'loginCaptchaInput'
                          : type === 'register' ? 'regCaptchaInput'
                          : 'forgotCaptchaInput';

            document.getElementById(displayId).innerText = result;
            document.getElementById(inputId).value = '';
        }

        function switchTab(ev, tab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            ev.currentTarget.classList.add('active');

            document.querySelectorAll('.form-tab').forEach(form => form.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');

            clearErrors();
        }

        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function openForgotModal() {
            document.getElementById('forgotModal').classList.add('show');
            generateCaptcha('forgot');
        }

        function closeForgotModal() {
            document.getElementById('forgotModal').classList.remove('show');
        }

        // New Success Modal Functions
        function openSuccessModal(msg, username) {
            document.getElementById('successMessageText').textContent = msg;
            document.getElementById('successModal').classList.add('show');
            registeredUser = username;
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('show');
            // Switch to Login Tab
            document.querySelectorAll('.tab-button')[0].click();
            if(registeredUser) {
                document.getElementById('loginUsername').value = registeredUser;
            }
        }

        window.onclick = function(e) {
            const fModal = document.getElementById('forgotModal');
            if (e.target === fModal) closeForgotModal();
            
            // Note: We don't close success modal on outside click to force user to click "Go to Login"
        }

        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
            document.querySelectorAll('input').forEach(el => el.classList.remove('error'));
        }

        function showError(id, msg) {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = msg;
            el.style.display = 'block';
        }

        function checkStrength(pass) {
            const bar = document.getElementById('strengthBar');
            const wrap = document.getElementById('strengthWrapper');
            wrap.classList.add('active');

            let strength = 0;
            if (pass.length >= 6) strength++;
            if (pass.length >= 10) strength++;
            if (/[A-Z]/.test(pass)) strength++;
            if (/[0-9]/.test(pass)) strength++;
            if (/[^A-Za-z0-9]/.test(pass)) strength++;

            bar.className = 'password-strength-bar';
            if (strength <= 2) bar.classList.add('strength-weak');
            else if (strength <= 4) bar.classList.add('strength-medium');
            else bar.classList.add('strength-strong');
        }

        function toggleLoading(type, isLoading) {
            const btn = document.getElementById(type + 'Btn');
            const loader = document.getElementById(type + 'Loading');

            if (isLoading) {
                btn.style.display = 'none';
                loader.style.display = 'block';
            } else {
                btn.style.display = 'block';
                loader.style.display = 'none';
            }
        }

        function loadRememberedUser() {
            const remembered = localStorage.getItem('doctorRememberUser');
            if (remembered) {
                document.getElementById('loginUsername').value = remembered;
                document.getElementById('rememberMe').checked = true;
            }
        }

        function saveRememberedUser(username) {
            if (document.getElementById('rememberMe').checked) {
                localStorage.setItem('doctorRememberUser', username);
            } else {
                localStorage.removeItem('doctorRememberUser');
            }
        }

        // ---- BACKEND CONNECTED LOGIN ----
        async function handleLogin(e) {
            e.preventDefault();
            clearErrors();

            const user = document.getElementById('loginUsername').value.trim();
            const pass = document.getElementById('loginPassword').value;
            const captchaInput = document.getElementById('loginCaptchaInput').value.trim();

            if (captchaInput.toLowerCase() !== captchas.login.toLowerCase()) {
                showError('loginCaptchaError', 'Incorrect security code.');
                generateCaptcha('login');
                return;
            }

            toggleLoading('login', true);

            try {
                const formData = new FormData();
                formData.append('action', 'login');
                formData.append('username', user);
                formData.append('password', pass);

                const response = await fetch('doctor_auth.php', {
                    method: 'POST',
                    body: formData
                });

                const ct = response.headers.get('content-type') || '';
                if (!ct.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    showError('loginPasswordError', 'Server error. Check console.');
                    generateCaptcha('login');
                    return;
                }

                const result = await response.json();

                if (result.success) {
                    saveRememberedUser(user);
                    window.location.href = 'doctor_dashboard.html';
                } else {
                    showError('loginPasswordError', result.message || 'Login failed');
                    generateCaptcha('login');
                }

            } catch (err) {
                console.error(err);
                showError('loginPasswordError', 'Network error. Please try again.');
                generateCaptcha('login');
            } finally {
                toggleLoading('login', false);
            }
        }

        // ---- BACKEND CONNECTED REGISTER ----
        async function handleRegister(e) {
            e.preventDefault();
            clearErrors();

            const user = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pass = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regConfirmPass').value;
            const captchaInput = document.getElementById('regCaptchaInput').value.trim();

            if (user.length < 3) {
                showError('regUsernameError', 'Username must be at least 3 characters.');
                return;
            }
            if (pass.length < 6) {
                showError('regPasswordError', 'Password must be at least 6 characters.');
                return;
            }
            if (pass !== confirm) {
                showError('regConfirmPassError', 'Passwords do not match.');
                return;
            }
            if (captchaInput.toLowerCase() !== captchas.register.toLowerCase()) {
                showError('regCaptchaError', 'Incorrect security code.');
                generateCaptcha('register');
                return;
            }

            toggleLoading('reg', true);

            try {
                const formData = new FormData();
                formData.append('action', 'register');
                formData.append('username', user);
                formData.append('email', email);
                formData.append('password', pass);

                const response = await fetch('doctor_auth.php', {
                    method: 'POST',
                    body: formData
                });

                const ct = response.headers.get('content-type') || '';
                if (!ct.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    showError('regPasswordError', 'Server error. Check console.');
                    generateCaptcha('register');
                    return;
                }

                const result = await response.json();

                if (result.success) {
                    // Show Popup Modal
                    openSuccessModal(result.message || 'Account created successfully! Please login.', user);
                    
                    document.getElementById('registerForm').reset();
                    generateCaptcha('register');
                } else {
                    const msg = result.message || 'Registration failed';
                    if (msg.toLowerCase().includes('username')) showError('regUsernameError', msg);
                    else if (msg.toLowerCase().includes('email')) showError('regEmailError', msg);
                    else showError('regPasswordError', msg);
                    generateCaptcha('register');
                }

            } catch (err) {
                console.error(err);
                showError('regUsernameError', 'Network error. Please try again.');
                generateCaptcha('register');
            } finally {
                toggleLoading('reg', false);
            }
        }

        // ---- BACKEND CONNECTED FORGOT ----
        async function handleForgot(e) {
            e.preventDefault();
            clearErrors();

            const email = document.getElementById('forgotEmail').value.trim();
            const captchaInput = document.getElementById('forgotCaptchaInput').value.trim();

            if (captchaInput.toLowerCase() !== captchas.forgot.toLowerCase()) {
                showError('forgotCaptchaError', 'Incorrect code.');
                generateCaptcha('forgot');
                return;
            }

            const btn = document.getElementById('forgotBtn');
            const loading = document.getElementById('forgotLoading');

            btn.style.display = 'none';
            loading.style.display = 'block';

            try {
                const formData = new FormData();
                formData.append('action', 'forgot_password');
                formData.append('email', email);

                const response = await fetch('doctor_auth.php', {
                    method: 'POST',
                    body: formData
                });

                const ct = response.headers.get('content-type') || '';
                if (!ct.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    alert('Server error. Check console.');
                    generateCaptcha('forgot');
                    return;
                }

                const result = await response.json();
                alert(result.message || 'If this email exists, a reset link will be sent.');
                closeForgotModal();

            } catch (err) {
                console.error(err);
                alert('Network error. Please try again.');
                generateCaptcha('forgot');
            } finally {
                btn.style.display = 'block';
                loading.style.display = 'none';
            }
        }

        async function checkSession() {
            try {
                const resp = await fetch('get_doctor_session.php', { cache: 'no-store' });
                const data = await resp.json();
                if (data.logged_in) window.location.href = 'doctor_dashboard.html';
            } catch (e) {
                console.log('Session check skipped:', e);
            }
        }
    </script>
</body>
</html>
