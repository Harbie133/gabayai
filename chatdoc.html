<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Consultation Room - GabayAI</title>
  <link rel="stylesheet" href="navbar.css?v=2">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    /* RESET */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      margin: 0;
      background: #f0f2f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    /* Navbar Styles */
    .page-wrapper {
      flex: 1;
      max-width: 1200px;
      margin: 70px auto 0;
      padding: 0 16px 16px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }

    /* DOCTOR BAR */
    .doctor-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 16px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .doctor-main {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }
    .doctor-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      background: #e5e7eb;
      flex-shrink: 0;
    }
    .doctor-text { min-width: 0; }
    .doctor-name {
      font-weight: 600;
      font-size: 1rem;
      color: #1f2937;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 200px;
    }
    .doctor-spec {
      font-size: .85rem;
      color: #6b7280;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 200px;
    }
    
    /* REMOVED: .doctor-status classes */

    .queue-badge {
      font-size: .75rem;
      color: #6b7280;
      margin-left: 8px;
      font-weight: 500;
    }

    /* LAYOUT GRID */
    .layout {
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr) 280px; /* 3 Columns Desktop */
      gap: 0;
      align-items: stretch;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
      background: #fff;
      height: calc(100vh - 160px); 
      min-height: 500px;
    }

    /* CONVERSATION LIST (LEFT) */
    .conversation-list {
      border-right: 1px solid #e5e7eb;
      background: #fff;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .conv-header {
      padding: 14px 16px;
      border-bottom: 1px solid #e5e7eb;
      font-size: .9rem;
      font-weight: 600;
      color: #374151;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f9fafb;
    }
    .conv-items { flex: 1; overflow-y: auto; }
    .conv-empty { font-size: .85rem; color: #9ca3af; text-align: center; padding: 30px 10px; }
    .conv-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      transition: background .15s;
      border-bottom: 1px solid #f3f4f6;
    }
    .conv-item:hover { background: #f9fafb; }
    .conv-item.active { background: #eff6ff; border-left: 3px solid #3b82f6; }
    .conv-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #e5e7eb; flex-shrink: 0; }
    .conv-main { min-width: 0; flex: 1; }
    .conv-name { font-size: .9rem; font-weight: 600; color: #111827; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .conv-preview { font-size: .8rem; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conv-meta { font-size: .7rem; color: #9ca3af; text-align: right; min-width: 50px; }
    .conv-status-pill { display: inline-block; padding: 2px 6px; border-radius: 999px; font-size: .7rem; background: #e0e7ff; color: #4338ca; margin-top: 4px; }

    /* CHAT PANEL (CENTER) */
    .chat-panel {
      background: #fff;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    .chat-log {
      flex: 1;
      padding: 20px;
      padding-bottom: 80px; /* SPACE FOR INPUT */
      overflow-y: auto;
      background: #f3f4f6;
      display: flex;
      flex-direction: column;
    }
    .chat-empty { text-align: center; margin: auto; color: #9ca3af; font-size: .95rem; }
    .chat-empty i { font-size: 2rem; margin-bottom: 10px; opacity: .5; }

    /* BUBBLES */
    .bubble-wrap { display: flex; flex-direction: column; margin-bottom: 8px; width: 100%; }
    .bubble { max-width: 75%; padding: 10px 14px; border-radius: 18px; margin: 2px 0; font-size: .95rem; line-height: 1.4; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .me { margin-left: auto; background: #3b82f6; color: #fff; border-bottom-right-radius: 4px; }
    .them { margin-right: auto; background: #fff; color: #1f2937; border-bottom-left-radius: 4px; }
    .meta { font-size: .7rem; opacity: .7; margin-top: 2px; text-align: right; padding: 0 4px; }
    
    /* INPUT AREA */
    .chat-input-wrap {
      border-top: 1px solid #e5e7eb;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      background: #fff;
    }
    .chat-input-wrap.hidden { display: none !important; }

    .attach-btn { border: none; background: transparent; color: #6b7280; font-size: 1.2rem; cursor: pointer; padding: 8px; border-radius: 50%; transition: background .2s; }
    .attach-btn:hover { background: #f3f4f6; color: #3b82f6; }
    .chat-input { flex: 1; border-radius: 24px; border: 1px solid #d1d5db; padding: 10px 16px; outline: none; font-size: .95rem; background: #f9fafb; transition: all .2s; }
    .chat-input:focus { border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
    .send-btn { border: none; border-radius: 24px; padding: 0 20px; background: #3b82f6; color: #fff; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: .9rem; height: 40px; transition: background .2s; }
    .send-btn:hover { background: #2563eb; }
    .send-btn[disabled] { opacity: .6; cursor: not-allowed; }

    /* SIDE PANEL (RIGHT) */
    .side-panel {
      background: #fff;
      border-left: 1px solid #e5e7eb;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
    }
    /* IMPORTANT: Ensure visible by default on desktop */
    .side-panel.hidden > * { display: none; } 

    .side-panel > div { padding-bottom: 12px; border-bottom: 1px solid #f3f4f6; }
    .side-panel h4 { margin: 0 0 6px; font-size: .85rem; text-transform: uppercase; color: #9ca3af; letter-spacing: 0.5px; font-weight: 700; }
    .summary-item { font-size: .95rem; color: #374151; margin: 0; line-height: 1.5; }
    .pill-list { display: flex; flex-wrap: wrap; gap: 6px; }
    .pill { padding: 4px 10px; border-radius: 999px; background: #eff6ff; color: #3b82f6; font-size: .8rem; font-weight: 500; }

    /* MOBILE RESPONSIVE */
    .mobile-back-btn { display: none; } 

    @media (max-width: 900px) {
      .layout { grid-template-columns: 240px minmax(0, 1fr); }
      .side-panel { display: none; } 
    }

    @media (max-width: 700px) {
      .page-wrapper { margin-top: 60px; padding: 10px; height: calc(100vh - 60px); }
      .doctor-bar { flex-direction: column; align-items: flex-start; gap: 8px; }
      .layout { grid-template-columns: 1fr; border: none; height: auto; flex: 1; }
      
      .layout.mobile-chat-active .conversation-list { display: none; }
      .layout.mobile-chat-active .chat-panel { display: flex; height: 100%; }
      
      .conversation-list { width: 100%; height: 100%; border: 1px solid #e5e7eb; border-radius: 12px; }
      
      /* FIXED: Position Chat Panel below header so Navbar is visible */
      .chat-panel { 
          display: none; 
          width: 100%; 
          height: calc(100vh - 70px); 
          position: fixed; 
          top: 70px; 
          left: 0; 
          z-index: 900; 
          padding-top: 0;
          padding-bottom: 0;
      }
      
      /* FIXED: Sticky Input at Bottom */
      .chat-input-wrap { 
          position: fixed; 
          bottom: 0; 
          left: 0; 
          width: 100%; 
          z-index: 1010; 
          padding: 8px; 
          background: #fff;
          border-top: 1px solid #eee;
          box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      }

      .mobile-back-btn { display: flex; align-items: center; gap: 6px; background: none; border: none; font-size: 1rem; color: #3b82f6; font-weight: 600; padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; background: #fff; }
      
      .chat-input { font-size: 16px; }
    }
  </style>
</head>
<body>
<nav class="navbar">
  <div class="navbar-container">
    <a href="homer.html" class="navbar-logo">GabayAI</a>
    <ul class="navbar-nav">
      <li><a href="homer.html" class="nav-link">Dashboard</a></li>
      <li><a href="analyzerv2.html" class="nav-link">Analyzer</a></li>
      <li><a href="consult.html" class="nav-link active">Consultation</a></li>
      <li><a href="editaccount.html" class="nav-link">Profile</a></li>
      <li>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </li>
    </ul>
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
      <div class="hamburger" id="hamburger">
        <span></span><span></span><span></span>
      </div>
    </button>
  </div>
  <div class="mobile-menu" id="mobileMenu">
    <div class="mobile-menu-items">
      <a href="homer.html" class="mobile-nav-link">Dashboard</a>
      <a href="analyzerv2.html" class="mobile-nav-link">Analyzer</a>
      <a href="consult.html" class="mobile-nav-link active">Consultation</a>
      <a href="editaccount.html" class="mobile-nav-link">Profile</a>
      <div class="mobile-logout">
        <button onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </div>
</nav>

<div class="page-wrapper">
  
  <div class="doctor-bar">
    <div class="doctor-main">
      <img id="docAvatar" class="doctor-avatar" src="" alt="Doctor">
      <div class="doctor-text">
        <div id="docName" class="doctor-name">Select a conversation</div>
        <div id="docSpec" class="doctor-spec"></div>
      </div>
    </div>
    <!-- REMOVED STATUS PILL HERE -->
    <div>
      <span id="queueBadge" class="queue-badge"></span>
    </div>
  </div>

  <div class="layout" id="chatLayout">
    
    <!-- LEFT: CONVERSATIONS -->
    <div class="conversation-list">
      <div class="conv-header">
        <span>Recent Chats</span>
        <i class="fas fa-history"></i>
      </div>
      <div id="convItems" class="conv-items">
        <div class="conv-empty">
           <i class="fas fa-spinner fa-spin"></i> Loading...
        </div>
      </div>
    </div>

    <!-- CENTER: CHAT -->
    <div class="chat-panel">
      <!-- Mobile Back Button -->
      <button class="mobile-back-btn" onclick="closeChatMobile()">
        <i class="fas fa-arrow-left"></i> Back to list
      </button>

      <div id="chatLog" class="chat-log">
        <div class="chat-empty">
          <i class="fas fa-comments"></i><br/>
          Select a conversation on the left to start chatting.
        </div>
      </div>
      
      <div class="chat-input-wrap hidden" id="chatInputWrap">
        <button id="attachBtn" class="attach-btn" type="button" title="Attach file">
          <i class="fas fa-paperclip"></i>
        </button>
        <input id="fileInput" type="file" style="display:none" multiple accept="image/*,application/pdf">
        
        <input id="msgInput" class="chat-input" type="text" placeholder="Type message..." autocomplete="off">
        <button id="sendBtn" class="send-btn">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>

    <!-- RIGHT: INFO (Desktop Only) -->
    <div class="side-panel hidden" id="sidePanel">
      <div>
        <h4>Chief complaint</h4>
        <p id="sideComplaint" class="summary-item">â€”</p>
      </div>
      <div>
        <h4>Key info</h4>
        <p id="sideInfo" class="summary-item">â€”</p>
      </div>
      <div>
        <h4>Topics</h4>
        <div id="sideTopics" class="pill-list"></div>
      </div>
    </div>

  </div>
</div>

<script src="auth-guard.js"></script>
<script>
  function logout() {
    if (confirm('Are you sure you want to logout?')) {
      window.location.href = 'user_logout.php';
    }
  }
  function toggleMobileMenu() {
    const mobileMenu = document.getElementById('mobileMenu');
    const hamburger = document.getElementById('hamburger');
    mobileMenu.classList.toggle('show');
    hamburger.classList.toggle('open');
  }

  const POLL_MS = 1000;
  
  const chatLog     = document.getElementById('chatLog');
  const msgInput    = document.getElementById('msgInput');
  const sendBtn     = document.getElementById('sendBtn');
  const convItemsEl = document.getElementById('convItems');
  const attachBtn   = document.getElementById('attachBtn');
  const fileInput   = document.getElementById('fileInput');
  const chatLayout  = document.getElementById('chatLayout');
  const chatInputWrap = document.getElementById('chatInputWrap');
  const sidePanel      = document.getElementById('sidePanel');

  let currentConsult = null;
  let lastMessageId  = 0;

  const params = new URLSearchParams(location.search);
  let consultationId = params.get('consult');

  function escapeHtml(str){
    const div = document.createElement('div');
    div.textContent = String(str ?? "");
    return div.innerHTML;
  }
  function avatarUrl(name){
    const safe = encodeURIComponent(name || "Doctor");
    return `https://ui-avatars.com/api/?name=${safe}&background=EEF2FF&color=3730A3&rounded=true&size=160`;
  }

  if (consultationId && window.innerWidth <= 800) {
    chatLayout.classList.add('mobile-chat-active');
  }
  
  function closeChatMobile() {
    chatLayout.classList.remove('mobile-chat-active');
    window.history.replaceState({}, document.title, window.location.pathname);
    consultationId = null;
    toggleUI(false); 
  }

  function toggleUI(show) {
    if(show) {
      chatInputWrap.classList.remove('hidden');
      sidePanel.classList.remove('hidden');
      chatInputWrap.style.display = 'flex'; 
    } else {
      chatInputWrap.classList.add('hidden');
      sidePanel.classList.add('hidden');
      chatInputWrap.style.display = 'none';
      document.getElementById('docName').textContent = 'Select a conversation';
      document.getElementById('docSpec').textContent = '';
      // Status update removed
    }
  }

  async function loadConversations(){
    try{
      const res = await fetch('get_patient_conversations.php', {cache:'no-store'});
      if(!res.ok) throw new Error('Failed to load');
      const data = await res.json();
      convItemsEl.innerHTML = '';

      if(!Array.isArray(data) || data.length === 0){
        convItemsEl.innerHTML = `
          <div class="conv-empty">
            No conversations yet.<br>Start a consultation first.
          </div>`;
        return;
      }

      data.forEach(conv=>{
        const isActive = (String(conv.consultation_id) === String(consultationId));
        const item = document.createElement('div');
        item.className = 'conv-item' + (isActive ? ' active' : '');
        item.onclick = () => {
          window.location.href = '?consult=' + conv.consultation_id;
        };

        const avatar = document.createElement('img');
        avatar.className = 'conv-avatar';
        avatar.src = avatarUrl(conv.doctor_name);
        item.appendChild(avatar);

        const main = document.createElement('div');
        main.className = 'conv-main';

        const nameEl = document.createElement('div');
        nameEl.className = 'conv-name';
        nameEl.textContent = conv.doctor_name || 'Doctor';
        main.appendChild(nameEl);

        const previewEl = document.createElement('div');
        previewEl.className = 'conv-preview';
        previewEl.textContent = conv.last_message || '(No messages)';
        main.appendChild(previewEl);

        item.appendChild(main);
        
        const meta = document.createElement('div');
        meta.className = 'conv-meta';
        meta.textContent = conv.last_time || '';
        item.appendChild(meta);

        convItemsEl.appendChild(item);
      });
    }catch(e){
      console.error(e);
      convItemsEl.innerHTML = '<div class="conv-empty">Error loading list.</div>';
    }
  }

  async function loadConsultationDetails(){
    if (!consultationId) {
      toggleUI(false);
      return;
    }
    try{
      const res = await fetch('get_consultation_details.php?consultationId=' + consultationId + '&t=' + new Date().getTime(), { cache: 'no-store' });
      if (!res.ok) return;
      const data = await res.json();

      if (data.error) { toggleUI(false); return; }

      // Show UI since we have data
      toggleUI(true);
      currentConsult = data;
      
      document.getElementById('docName').textContent = data.doctorName || "Doctor";
      document.getElementById('docSpec').textContent = data.doctorSpecialization || "General";
      document.getElementById('docAvatar').src = avatarUrl(data.doctorName);
      // Status update removed

      const p = data.patient || {};
      const infoParts = [p.age ? p.age+' yrs' : '', p.sex || '', p.duration || ''].filter(Boolean);
      document.getElementById('sideInfo').textContent = infoParts.join(" Â· ") || "â€”";
      document.getElementById('sideComplaint').textContent = p.complaint || "â€”";
      
      const topicsWrap = document.getElementById('sideTopics');
      topicsWrap.innerHTML = "";
      
      let rawTopics = p.topics;
      let finalTopics = [];

      if (Array.isArray(rawTopics)) {
         finalTopics = rawTopics;
      } else if (typeof rawTopics === 'string') {
         try { finalTopics = JSON.parse(rawTopics); }
         catch(e) { finalTopics = rawTopics.split(',').map(s=>s.trim()); }
      }

      if(finalTopics.length > 0){
        finalTopics.forEach(t => {
            if(t && typeof t === 'string'){
                const cleanT = t.replace(/[\[\]"]/g, '');
                if(cleanT.trim()){
                    const s = document.createElement('span'); 
                    s.className='pill'; 
                    s.textContent=cleanT;
                    topicsWrap.appendChild(s);
                }
            }
        });
      } else {
        topicsWrap.innerHTML = '<span style="color:#aaa; font-size:0.8rem">No topics</span>';
      }

    }catch(e){ console.error(e); }
  }

  async function pollMessages(){
    if(!consultationId) return;
    try{
      const res = await fetch(`getMessages.php?consultationId=${consultationId}&since=${lastMessageId}`, {cache:'no-store'});
      if(!res.ok) return;
      const data = await res.json();
      
      if(!Array.isArray(data)) return;
      
      if (lastMessageId === 0 && data.length > 0) {
         const empty = chatLog.querySelector('.chat-empty');
         if(empty) empty.remove();
      }

      data.forEach(m=>{
        lastMessageId = Math.max(lastMessageId, m.id);
        appendMessage(m);
      });
    }catch(e){ console.error(e); }
  }

  function appendMessage(msg){
    const wrap = document.createElement('div');
    wrap.className = 'bubble-wrap';

    const isMe = msg.sender === 'patient';
    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + (isMe ? 'me' : 'them');

    if (msg.text && msg.text.trim()) {
      const t = document.createElement('div');
      t.innerHTML = escapeHtml(msg.text);
      bubble.appendChild(t);
    }

    if (msg.attachment && msg.attachment.file_path) {
      const att = msg.attachment;
      if (att.file_type && att.file_type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = att.file_path;
        img.style.maxWidth = '100%';
        img.style.borderRadius = '12px';
        img.style.marginTop = '6px';
        img.style.cursor = 'pointer';
        img.onclick = () => window.open(att.file_path, '_blank');
        bubble.appendChild(img);
      } else {
        const link = document.createElement('a');
        link.href = att.file_path;
        link.textContent = 'ðŸ“Ž ' + (att.file_name || 'Attachment');
        link.target = '_blank';
        link.style.display = 'block';
        link.style.marginTop = '4px';
        link.style.color = isMe ? '#fff' : '#2563eb';
        bubble.appendChild(link);
      }
    }

    wrap.appendChild(bubble);

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = msg.time || '';
    wrap.appendChild(meta);

    chatLog.appendChild(wrap);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  async function sendMessage(){
    const text = msgInput.value.trim();
    if(!text || !consultationId) return;

    sendBtn.disabled = true;
    
    appendMessage({
      sender: 'patient', text: text, time: 'Sending...', id: 0
    });
    msgInput.value = '';

    try{
      await fetch('sendMessage_patient.php', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ consultationId, message: text, sender: 'patient' })
      });
      pollMessages(); 
    }catch(e){ alert('Failed to send'); }
    finally{ sendBtn.disabled = false; }
  }

  async function sendAttachment(){
    if (!consultationId || !fileInput.files.length) return;
    const file = fileInput.files[0];
    const text = msgInput.value.trim();

    const formData = new FormData();
    formData.append('consultationId', consultationId);
    formData.append('message', text);
    formData.append('file', file);
    formData.append('sender', 'patient');

    appendMessage({
      sender: 'patient', text: text, time: 'Uploading...',
      attachment: {
        file_path: URL.createObjectURL(file),
        file_type: file.type
      }
    });
    msgInput.value = '';
    sendBtn.disabled = true;

    try{
      const res = await fetch('upload_attachment_patient.php', { method: 'POST', body: formData });
      const d = await res.json();
      if(!d.success) alert(d.error);
      else pollMessages();
    }catch(e){ alert('Upload error'); }
    finally { sendBtn.disabled = false; fileInput.value = ''; }
  }

  attachBtn.onclick = () => fileInput.click();
  fileInput.onchange = () => { if(fileInput.files.length) sendAttachment(); };
  sendBtn.onclick = sendMessage;
  msgInput.onkeydown = (e) => { if(e.key==='Enter') sendMessage(); };

  loadConversations();
  if(consultationId) {
    toggleUI(true); // Ensure UI shows immediately
    loadConsultationDetails();
    pollMessages();
    setInterval(pollMessages, POLL_MS);
  } else {
    toggleUI(false); 
  }
</script>
</body>
</html>
