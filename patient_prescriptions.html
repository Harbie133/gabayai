<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Prescriptions - GabayAI</title>
  <link rel="stylesheet" href="navbar.css"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; margin:0; color: #2d3748;
    }
    .container { background:#fff; padding:35px 40px; border-radius:16px; box-shadow:0 8px 30px rgba(0,0,0,.08); width:700px; max-width:98%; margin:50px auto;}
    h2 { color:#4c6ef5; font-weight:600; font-size:26px; margin:14px 0 24px 0; text-align:center;}
    .stats-row { display:grid; grid-template-columns:repeat(3,1fr);gap:15px; margin-bottom:28px;}
    .stat-box { background:linear-gradient(135deg,#4c6ef5,#667eea);padding:18px;border-radius:12px;text-align:center;color:#fff;}
    .stat-box h3 { font-size:27px; margin-bottom:7px; font-weight:bold;}
    .filter-tabs { display:flex;gap:10px;margin-bottom:16px; justify-content:center;}
    .filter-tab { padding:8px 20px;background:#fff;border:2px solid #4c6ef5;color:#4c6ef5;border-radius:25px;cursor:pointer;font-weight:500;transition:.17s;font-size:15px;}
    .filter-tab.active { background:#4c6ef5;color:#fff;}
    .prescriptions-list { display:flex;flex-direction:column;gap:20px;}
    .prescription-card { background: #f8f9fa; border: 1.5px solid #e2e8f0; box-shadow:0 1.5px 9px rgba(76,110,245,0.05); border-radius:14px; padding:24px; cursor:pointer; position:relative; transition:.17s; border-left:5px solid #4c6ef5;}
    .prescription-card:hover { box-shadow:0 6px 20px rgba(76,110,245,.13); background:#f4f6ff;}
    .prescription-header { display:flex; align-items:center; margin-bottom:10px;gap:15px;}
    .prescription-id { color:#3974f2;font-size:18px;font-weight:600;margin-right:12px;}
    .prescription-date { font-size:13px; color:#666; display:flex;align-items:center;gap:5px;}
    .status-badge { margin-left:auto; padding:4px 20px;border-radius:15px;font-size:12px;font-weight:700; background:#e5f5e0; color:#199146;}
    .status-badge.completed{background:#e8f1ff;color:#13428b;}
    .status-badge.cancelled{background:#fce6e8;color:#af2333;}
    .card-row{display:flex;gap:25px;margin-bottom:6px;}
    .info-label{font-weight:600;min-width:110px;color:#4c6ef5;}
    .diagnosis-section{border-radius:8px;background:#fff;border-left:4px solid #4c6ef5; margin:12px 0 6px 0; padding:14px;}
    .diagnosis-title{color:#3974f2;font-size:13px; margin:0 0 7px 0; font-weight:700;text-transform:uppercase;}
    .diagnosis-section p{color:#2d3748;font-size:15px;margin:0;}
    .notes-section{background:#fffde9; border-left:4px solid #ffc107;border-radius:8px;padding:12px;margin:9px 0;}
    .notes-title{color:#e3b700;font-size:13px;font-weight:700;text-transform:uppercase;}
    .notes-section p{color:#514906;font-size:15px;}
    .meds-section{background:#f6fafd; border-left:4px solid #43a1d7; border-radius:8px; padding:12px; margin:10px 0 0 0;}
    .meds-title{color:#399ad6; font-size:13px;font-weight:700; text-transform:uppercase;}
    .medication-list{margin-top:7px;}
    .medication-row{background:#fff; border-radius:6px;padding:7px 10px; border-left:3px solid #43a1d7; margin-bottom:5px;}
    .medication-row strong{color:#2783b0;}
    .prescription-actions{margin-top:11px;}
    .btn-download{background:#4c6ef5;color:#fff;border:none;border-radius:8px;padding:11px;width:100%;font-size:16px;font-weight:600;transition:.13s;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;}
    .btn-download:hover{background:#376ed3;}
    .empty-state{text-align:center;color:#a0aec0;margin-top:40px;font-size:18px;}
    /* MODAL */
    .modal-overlay{display:none;position:fixed;z-index:1010;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);align-items:center;justify-content:center;}
    .modal-overlay.show{display:flex;}
    .modal{background:white;border-radius:16px;padding:34px 20px;max-width:430px;width:96%;box-shadow:0 15px 44px rgba(65,105,225,0.15);position:relative;animation:popin .15s;}
    .modal .close-modal{background:none;border:none;position:absolute;top:10px;right:15px;font-size:25px;color:#667eea;cursor:pointer;}
    .modal-header{margin-bottom:15px;}
    .modal-header h3{margin:0;color:#4c6ef5;font-size:20px;font-weight:700;}
    .modal-content .card-row{margin-bottom:7px;}
    .modal-content .diagnosis-section,.modal-content .notes-section,.modal-content .meds-section{margin-top:8px;}
    @keyframes popin{from{transform:scale(.92);opacity:.85;}to{transform:scale(1);opacity:1;}}
    @media (max-width: 850px){.container{width:98%;padding:12px;} .modal{padding:12px;}}
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-container">
      <a href="homer.html" class="navbar-logo">GabayAI</a>
      <ul class="navbar-nav">
        <li><a href="homer.html" class="nav-link">Dashboard</a></li>
        <li><a href="analyzer.html" class="nav-link">Analyzer</a></li>
        <li><a href="consult.html" class="nav-link">Consultation</a></li>
        <li><a href="profile.html" class="nav-link">Profile</a></li>
        <li>
          <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </li>
      </ul>
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>
      </button>
    </div>
    <div class="mobile-menu" id="mobileMenu">
      <div class="mobile-menu-items">
        <a href="homer.html" class="mobile-nav-link">Dashboard</a>
        <a href="analyzer.html" class="mobile-nav-link">Analyzer</a>
        <a href="consult.html" class="mobile-nav-link">Consultation</a>
        <a href="profile.html" class="mobile-nav-link">Profile</a>
        <div class="mobile-logout">
          <button onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </div>
      </div>
    </div>
  </nav>
  <div class="container">
    <h2><i class="fas fa-prescription"></i> My Prescriptions</h2>
    <div class="stats-row">
      <div class="stat-box"><h3 id="totalCount">0</h3><p>Total</p></div>
      <div class="stat-box"><h3 id="activeCount">0</h3><p>Active</p></div>
      <div class="stat-box"><h3 id="completedCount">0</h3><p>Completed</p></div>
    </div>
    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all" onclick="filterPrescriptions('all')">All</button>
      <button class="filter-tab" data-filter="Active" onclick="filterPrescriptions('Active')">Active</button>
      <button class="filter-tab" data-filter="Completed" onclick="filterPrescriptions('Completed')">Completed</button>
      <button class="filter-tab" data-filter="Cancelled" onclick="filterPrescriptions('Cancelled')">Cancelled</button>
    </div>
    <div class="prescriptions-list" id="prescriptionsList"></div>
    <div class="empty-state" id="emptyState" style="display:none;">
      <i class="fas fa-prescription-bottle"></i>
      <div>No Prescriptions Found</div>
    </div>
  </div>
  <!-- MODAL -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <button class="close-modal" onclick="closeModal()">&times;</button>
      <div class="modal-header"><h3 id="modalTitle"></h3></div>
      <div class="modal-content" id="modalContent"></div>
    </div>
  </div>
  <script src="auth-guard.js"></script>
  <script>
    let allPrescriptions = [];
    let currentFilter = 'all';

    function logout() { if (confirm('Are you sure you want to logout?')) window.location.href = 'user_logout.php'; }
    function toggleMobileMenu(){
      const m=document.getElementById('mobileMenu'),h=document.getElementById('hamburger');
      m.classList.toggle('show'); h.classList.toggle('open');
    }
    document.addEventListener('click',function(e){
      const mm=document.getElementById('mobileMenu'),h=document.getElementById('hamburger');
      if(!e.target.closest('.mobile-menu-btn')&&!e.target.closest('.mobile-menu'))
        if(mm.classList.contains('show')){mm.classList.remove('show');h.classList.remove('open');}
    });

    window.addEventListener('DOMContentLoaded', loadPrescriptions);
    async function loadPrescriptions() {
      try {
        const response = await fetch('get_patient_prescriptions.php');
        const data = await response.json();
        if (data.success) {
          allPrescriptions = data.prescriptions;
          updateStats(allPrescriptions);
          displayPrescriptions(allPrescriptions);
        } else { showError(data.message||'Failed to load prescriptions'); }
      } catch (error) { showError('Failed to load prescriptions.'); }
    }
    function updateStats(prescriptions) {
      const total = prescriptions.length, active = prescriptions.filter(p=>p.status==='Active').length, completed = prescriptions.filter(p=>p.status==='Completed').length;
      document.getElementById('totalCount').textContent = total;
      document.getElementById('activeCount').textContent = active;
      document.getElementById('completedCount').textContent = completed;
    }
    function displayPrescriptions(prescriptions) {
      const list=document.getElementById('prescriptionsList'), empty=document.getElementById('emptyState');
      if(prescriptions.length===0){list.style.display='none';empty.style.display='block';return;}
      list.style.display='flex';empty.style.display='none';
      list.innerHTML = prescriptions.map(p => `
        <div class="prescription-card" onclick="showModal(${p.prescription_id})">
          <div class="prescription-header">
            <div class="prescription-id">Prescription #${p.prescription_id}</div>
            <div class="prescription-date"><i class="fas fa-calendar"></i> ${formatDate(p.prescription_date)}</div>
            <span class="status-badge ${p.status?p.status.toLowerCase():''}">${p.status}</span>
          </div>
          <div class="card-row"><span class="info-label">Doctor:</span><span>${p.doctor_name||'Not specified'}</span></div>
          ${p.appointment_id?`<div class="card-row"><span class="info-label">Appointment:</span><span>#${p.appointment_id}</span></div>`:''}
          <div class="diagnosis-section"><div class="diagnosis-title"><i class="fas fa-stethoscope"></i> Diagnosis</div><p>${p.diagnosis}</p></div>
          ${medicationsHTML(p.medications)}
          ${p.additional_notes?`<div class="notes-section"><div class="notes-title"><i class="fas fa-sticky-note"></i> Additional Notes</div><p>${p.additional_notes}</p></div>`:''}
          <div class="prescription-actions"><button class="btn-download" onclick="event.stopPropagation();downloadPrescription(${p.prescription_id})"><i class="fas fa-download"></i> Download PDF</button></div>
        </div>
      `).join('');
    }
    function medicationsHTML(meds) {
      if(!meds || !Array.isArray(meds) || meds.length === 0) return '';
      return `<div class="meds-section"><div class="meds-title"><i class="fas fa-pills"></i> Medications</div>
        <div class="medication-list">
        ${meds.map(m=>`<div class="medication-row">
          <strong>${m.medication_name}</strong>
          ${m.dosage?`<span> - ${m.dosage}</span>`:''}
          ${m.frequency?`<span> | <em>${m.frequency}</em></span>`:''}
          ${m.duration?`<span> | <em>${m.duration}</em></span>`:''}
          ${m.instructions?`<br><small style='color:#666'>${m.instructions}</small>`:''}
        </div>`).join('')}
        </div></div>`;
    }
    function filterPrescriptions(status) {
      currentFilter = status;
      document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.toggle('active', tab.getAttribute('data-filter')===status));
      displayPrescriptions(status==='all'?allPrescriptions:allPrescriptions.filter(p=>p.status===status));
    }
    function formatDate(dateStr){const d=new Date(dateStr);return d.toLocaleString('en-US',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});}
    function showError(msg){alert(msg);}
    function showModal(id){
      const p=allPrescriptions.find(x=>x.prescription_id==id);if(!p)return;
      document.getElementById('modalTitle').textContent=`Prescription #${p.prescription_id}`;
      document.getElementById('modalContent').innerHTML = `
        <div class="card-row"><span class="info-label">Date:</span><span>${formatDate(p.prescription_date)}</span></div>
        <div class="card-row"><span class="info-label">Doctor:</span><span>${p.doctor_name||'Not specified'}</span></div>
        ${p.appointment_id?`<div class="card-row"><span class="info-label">Appointment:</span><span>#${p.appointment_id}</span></div>`:''}
        <div class="diagnosis-section"><div class="diagnosis-title"><i class="fas fa-stethoscope"></i> Diagnosis</div><p>${p.diagnosis}</p></div>
        ${medicationsHTML(p.medications)}
        ${p.additional_notes?`<div class="notes-section"><div class="notes-title"><i class="fas fa-sticky-note"></i> Additional Notes</div><p>${p.additional_notes}</p></div>`:''}
        <div class="prescription-actions" style="margin-top:11px;">
          <button class="btn-download" style="width:100%;" onclick="downloadPrescription(${p.prescription_id})"><i class="fas fa-download"></i> Download PDF</button>
        </div>
      `;
      document.getElementById('modalOverlay').classList.add('show');
    }
    function closeModal(){document.getElementById('modalOverlay').classList.remove('show');}
    function downloadPrescription(id){window.open(`download_prescription.php?id=${id}`,'_blank');}
  </script>
</body>
</html>
